<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <title>LuvLang ULTIMATE - Professional Audio Mastering Suite</title>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0a0a0f;
            color: #ffffff;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
           PROFESSIONAL 3-COLUMN LAYOUT (SSL/Neve Console Style)
           â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” */
        .app-container {
            display: grid;
            grid-template-columns: 280px 1fr 320px;
            height: 100vh;
            overflow: hidden;
        }

        /* LEFT SIDEBAR - Upload, Controls, Presets */
        .left-sidebar {
            background: linear-gradient(180deg, #1a1a24 0%, #0f0f16 100%);
            border-right: 1px solid rgba(0, 212, 255, 0.1);
            overflow-y: auto;
            padding: 15px;
        }

        /* CENTER MAIN - EQ Graph, Waveform, EQ, Dynamics */
        .center-main {
            background: #0a0a0f;
            overflow-y: auto;
            padding: 15px;
        }

        /* RIGHT SIDEBAR - Meters, Master Section, Export */
        .right-sidebar {
            background: linear-gradient(180deg, #1a1a24 0%, #0f0f16 100%);
            border-left: 1px solid rgba(184, 79, 255, 0.1);
            overflow-y: auto;
            padding: 15px;
        }

        /* â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
           HEADER & BRANDING
           â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” */
        .header-logo {
            text-align: center;
            margin-bottom: 18px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .logo-text {
            font-size: 1.4rem;
            font-weight: 800;
            background: linear-gradient(135deg, #00d4ff 0%, #b84fff 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: -0.5px;
        }

        .logo-subtitle {
            font-size: 0.65rem;
            text-transform: uppercase;
            letter-spacing: 2px;
            opacity: 0.5;
            margin-top: 5px;
        }

        /* â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
           SECTION TITLES
           â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” */
        .section-title {
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            margin-bottom: 12px;
            color: #00d4ff;
            opacity: 0.9;
        }

        /* â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
           UPLOAD AREA
           â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” */
        .upload-area {
            border: 2px dashed rgba(0, 212, 255, 0.3);
            border-radius: 12px;
            padding: 20px 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 15px;
            background: rgba(0, 212, 255, 0.02);
        }

        .upload-area:hover {
            border-color: #00d4ff;
            background: rgba(0, 212, 255, 0.08);
        }

        .upload-icon {
            font-size: 1.8rem;
            margin-bottom: 8px;
        }

        .upload-text {
            font-size: 0.75rem;
            opacity: 0.7;
        }

        /* â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
           GENRE & PLATFORM SELECTORS
           â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” */
        .selector-group {
            margin-bottom: 15px;
        }

        .selector-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }

        .selector-btn {
            padding: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(255, 255, 255, 0.02);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.75rem;
            color: white;
            text-align: center;
        }

        .selector-btn:hover {
            border-color: #00d4ff;
            background: rgba(0, 212, 255, 0.1);
        }

        .selector-btn.active {
            border-color: #00d4ff;
            background: rgba(0, 212, 255, 0.2);
            box-shadow: 0 0 15px rgba(0, 212, 255, 0.3);
        }

        /* â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
           QUICK ACTIONS
           â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” */
        .action-btn {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 10px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 8px;
        }

        .action-btn-primary {
            background: linear-gradient(135deg, #00d4ff, #0088cc);
            color: white;
        }

        .action-btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 212, 255, 0.4);
        }

        .action-btn-secondary {
            background: linear-gradient(135deg, #b84fff, #764ba2);
            color: white;
        }

        .action-btn-secondary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(184, 79, 255, 0.4);
        }

        .action-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        /* â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
           PROFESSIONAL EQ GRAPH (CRITICAL - User specifically wants this)
           â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” */
        .eq-graph-container {
            background: linear-gradient(135deg, rgba(0, 0, 0, 0.8), rgba(20, 20, 40, 0.9));
            border-radius: 15px;
            padding: 18px;
            margin-bottom: 15px;
            border: 1px solid rgba(0, 212, 255, 0.2);
            position: relative;
        }

        .eq-graph-canvas {
            width: 100%;
            height: 200px; /* OPTIMIZED: Reduced from 280px to match Pro-Q 3 standard */
            background: linear-gradient(180deg, #0a0a0a 0%, #1a1a1a 50%, #0f0f0f 100%);
            border-radius: 10px;
            box-shadow: inset 0 1px 0 rgba(255,255,255,0.05), 0 8px 24px rgba(0, 0, 0, 0.8);
            border: 1px solid #000;
            display: block;
        }

        /* â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
           WAVEFORM VISUALIZER
           â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” */
        .waveform-container {
            background: linear-gradient(135deg, rgba(0, 0, 0, 0.8), rgba(20, 20, 40, 0.9));
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 15px;
            border: 1px solid rgba(0, 212, 255, 0.2);
        }

        .waveform-canvas {
            width: 100%;
            height: 70px; /* OPTIMIZED: Reduced from 100px - more compact, professional look */
            background: rgba(0, 0, 0, 0.4);
            border-radius: 10px;
        }

        /* â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
           TRANSPORT CONTROLS
           â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” */
        .transport-controls {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: rgba(0, 0, 0, 0.4);
            border-radius: 10px;
            margin-bottom: 15px;
        }

        .play-btn {
            width: 42px;
            height: 42px;
            border-radius: 50%;
            background: linear-gradient(135deg, #00d4ff, #0088cc);
            border: none;
            color: white;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .play-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 8px 25px rgba(0, 212, 255, 0.5);
        }

        .progress-bar {
            flex: 1;
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            cursor: pointer;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #00d4ff, #b84fff);
            width: 0%;
            transition: width 0.1s;
        }

        .time-display {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.85rem;
            opacity: 0.7;
        }

        /* â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
           PROFESSIONAL 7-BAND EQ WITH VERTICAL DRAGGABLE FADERS
           â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” */
        .eq-section {
            background: linear-gradient(135deg, rgba(0, 0, 0, 0.8), rgba(20, 20, 40, 0.9));
            border-radius: 15px;
            padding: 18px;
            margin-bottom: 15px;
            border: 1px solid rgba(0, 212, 255, 0.2);
        }

        .eq-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .eq-bypass-btn {
            padding: 6px 14px;
            border: 1px solid #00d4ff;
            background: rgba(0, 212, 255, 0.1);
            border-radius: 6px;
            color: #00d4ff;
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .eq-bypass-btn:hover {
            background: rgba(0, 212, 255, 0.2);
        }

        .eq-bypass-btn.bypassed {
            background: rgba(255, 0, 0, 0.2);
            border-color: #ff4444;
            color: #ff4444;
        }

        .eq-faders {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 12px;
            align-items: end;
            padding: 15px 8px;
            background: linear-gradient(180deg, #0d0d0d 0%, #1a1a1a 50%, #141414 100%);
            border-radius: 10px;
            min-height: 280px;
        }

        .eq-fader-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .eq-fader-label {
            font-size: 0.7rem;
            font-weight: 600;
            text-align: center;
            color: #00d4ff;
            min-height: 28px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .eq-fader-track {
            position: relative;
            width: 32px;
            height: 180px;
            background: linear-gradient(180deg,
                rgba(0, 212, 255, 0.1) 0%,
                rgba(255, 255, 255, 0.05) 50%,
                rgba(184, 79, 255, 0.1) 100%
            );
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            cursor: pointer;
        }

        .eq-fader-thumb {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            width: 40px;
            height: 20px;
            background: linear-gradient(135deg, #00d4ff, #0088cc);
            border-radius: 10px;
            cursor: grab;
            transition: box-shadow 0.2s ease;
            border: 2px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 4px 15px rgba(0, 212, 255, 0.4);
        }

        .eq-fader-thumb:hover {
            box-shadow: 0 6px 25px rgba(0, 212, 255, 0.6);
        }

        .eq-fader-thumb:active {
            cursor: grabbing;
            box-shadow: 0 8px 30px rgba(0, 212, 255, 0.8);
        }

        .eq-fader-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.7rem;
            font-weight: 600;
            color: #00d4ff;
            text-align: center;
            min-width: 55px;
        }

        .eq-fader-center {
            position: absolute;
            left: 0;
            right: 0;
            top: 50%;
            height: 2px;
            background: rgba(255, 255, 255, 0.2);
            pointer-events: none;
        }

        .eq-fader-freq {
            font-size: 0.65rem;
            opacity: 0.6;
            text-align: center;
        }

        /* â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
           DYNAMICS SECTION
           â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” */
        .dynamics-section {
            background: linear-gradient(135deg, rgba(0, 0, 0, 0.8), rgba(20, 20, 40, 0.9));
            border-radius: 15px;
            padding: 18px;
            border: 1px solid rgba(184, 79, 255, 0.2);
            margin-bottom: 15px;
        }

        .dynamics-controls {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .control-item {
            background: rgba(0, 0, 0, 0.3);
            padding: 12px;
            border-radius: 10px;
        }

        .control-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .control-name {
            font-size: 0.75rem;
            font-weight: 600;
        }

        .control-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.8rem;
            font-weight: 700;
            color: #b84fff;
        }

        .slider {
            width: 100%;
            height: 6px;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.1);
            outline: none;
            -webkit-appearance: none;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: linear-gradient(135deg, #b84fff, #764ba2);
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 0 10px rgba(184, 79, 255, 0.6);
        }

        .slider::-webkit-slider-thumb:hover {
            transform: scale(1.2);
            box-shadow: 0 0 15px rgba(184, 79, 255, 0.8);
        }

        /* â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
           PROFESSIONAL METERS (RIGHT SIDEBAR - 9 BROADCAST-GRADE METERS)
           â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” */
        .meters-container {
            background: linear-gradient(135deg, rgba(0, 0, 0, 0.8), rgba(20, 20, 40, 0.9));
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 15px;
            border: 1px solid rgba(0, 212, 255, 0.2);
        }

        .meter-item {
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .meter-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .meter-label {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            opacity: 0.6;
            margin-bottom: 6px;
        }

        .meter-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1rem;
            font-weight: 700;
            color: #00d4ff;
            text-shadow: 0 0 10px rgba(0, 212, 255, 0.5);
        }

        .meter-bar {
            width: 100%;
            height: 8px;
            background: rgba(0, 0, 0, 0.4);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 6px;
        }

        .meter-bar-fill {
            height: 100%;
            transition: width 0.1s ease;
            border-radius: 6px;
        }

        /* â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
           MASTER SECTION
           â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” */
        .master-section {
            background: linear-gradient(135deg, rgba(0, 0, 0, 0.8), rgba(20, 20, 40, 0.9));
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 15px;
            border: 1px solid rgba(184, 79, 255, 0.2);
        }

        /* â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
           ANALYSIS RESULTS PANEL (NEW - INDUSTRY LEADING)
           â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” */
        .analysis-panel {
            background: linear-gradient(135deg, rgba(0, 212, 255, 0.05), rgba(184, 79, 255, 0.05));
            border: 1px solid rgba(0, 212, 255, 0.3);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            display: none;
        }

        .analysis-panel.visible {
            display: block;
            animation: slideIn 0.4s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .analysis-results h4 {
            font-size: 0.9rem;
            margin-bottom: 12px;
            color: #00d4ff;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .analysis-section {
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            font-size: 0.8rem;
        }

        .analysis-section:last-child {
            border-bottom: none;
        }

        .analysis-section strong {
            color: #00d4ff;
            margin-right: 8px;
        }

        .analysis-section .confidence {
            color: rgba(255, 255, 255, 0.5);
            font-size: 0.75rem;
            margin-left: 5px;
        }

        .analysis-section .warning {
            color: #ff9500;
        }

        .analysis-section .good {
            color: #00ff88;
        }

        .analysis-section .critical {
            color: #ff4444;
        }

        .problems-detected {
            background: rgba(255, 69, 0, 0.1);
            border: 1px solid rgba(255, 69, 0, 0.3);
            border-radius: 8px;
            padding: 10px;
            margin-top: 8px;
        }

        .problems-detected strong {
            color: #ff9500;
        }

        .problems-detected ul {
            list-style: none;
            margin-top: 8px;
        }

        .problems-detected li {
            padding: 6px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .problems-detected li:last-child {
            border-bottom: none;
        }

        .problems-detected small {
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.7rem;
        }

        .problem-critical {
            color: #ff4444;
        }

        .problem-warning {
            color: #ff9500;
        }

        .problem-info {
            color: #00d4ff;
        }

        .all-good {
            color: #00ff88;
            padding: 8px;
            background: rgba(0, 255, 136, 0.1);
            border-radius: 6px;
            margin-top: 8px;
            text-align: center;
        }

        /* â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
           EXPORT SECTION
           â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” */
        .export-section {
            background: linear-gradient(135deg, rgba(0, 0, 0, 0.8), rgba(20, 20, 40, 0.9));
            border-radius: 15px;
            padding: 15px;
            border: 1px solid rgba(0, 212, 255, 0.2);
        }

        .export-format-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-bottom: 12px;
        }

        .export-format-btn {
            padding: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(255, 255, 255, 0.02);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.75rem;
            text-align: center;
        }

        .export-format-btn:hover {
            border-color: #00d4ff;
            background: rgba(0, 212, 255, 0.1);
        }

        .export-format-btn.active {
            border-color: #00d4ff;
            background: rgba(0, 212, 255, 0.2);
            box-shadow: 0 0 15px rgba(0, 212, 255, 0.3);
        }

        .export-btn {
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 10px;
            font-size: 0.95rem;
            font-weight: 700;
            cursor: pointer;
            background: linear-gradient(135deg, #00d4ff, #b84fff);
            color: white;
            transition: all 0.3s ease;
        }

        .export-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(0, 212, 255, 0.5);
        }

        .export-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        /* â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
           SCROLLBAR STYLING
           â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” */
        .left-sidebar::-webkit-scrollbar,
        .center-main::-webkit-scrollbar,
        .right-sidebar::-webkit-scrollbar {
            width: 8px;
        }

        .left-sidebar::-webkit-scrollbar-track,
        .center-main::-webkit-scrollbar-track,
        .right-sidebar::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.2);
        }

        .left-sidebar::-webkit-scrollbar-thumb,
        .center-main::-webkit-scrollbar-thumb,
        .right-sidebar::-webkit-scrollbar-thumb {
            background: rgba(0, 212, 255, 0.3);
            border-radius: 10px;
        }

        .left-sidebar::-webkit-scrollbar-thumb:hover,
        .center-main::-webkit-scrollbar-thumb:hover,
        .right-sidebar::-webkit-scrollbar-thumb:hover {
            background: rgba(0, 212, 255, 0.5);
        }

        /* â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
           PROGRESS OVERLAY
           â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” */
        .progress-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.95);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            backdrop-filter: blur(10px);
        }

        .progress-content {
            text-align: center;
            padding: 30px;
            border-radius: 20px;
            background: linear-gradient(135deg, rgba(0, 212, 255, 0.1), rgba(184, 79, 255, 0.1));
            border: 1px solid rgba(0, 212, 255, 0.3);
        }

        .progress-spinner {
            font-size: 3rem;
            margin-bottom: 15px;
            animation: spin 2s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .progress-text {
            font-size: 1.2rem;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .progress-detail {
            font-size: 0.85rem;
            opacity: 0.7;
        }
    </style>
</head>
<body>
    <!-- HIDDEN AUDIO ELEMENT -->
    <audio id="audioElement" style="display: none;"></audio>
    <input type="file" id="audioFileInput" accept="audio/*" style="display: none;">

    <!-- â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
         3-COLUMN PROFESSIONAL LAYOUT
         â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” -->
    <div class="app-container">

        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
             LEFT SIDEBAR - Upload, Genre, Platform, Quick Actions
             â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <div class="left-sidebar">

            <!-- HEADER LOGO -->
            <div class="header-logo">
                <div class="logo-text">LuvLang ULTIMATE</div>
                <div class="logo-subtitle">SSL/Neve Grade Mastering</div>
            </div>

            <!-- UPLOAD AREA -->
            <div class="section-title">Upload Audio</div>
            <div class="upload-area" id="uploadArea">
                <div class="upload-icon">ğŸµ</div>
                <div class="upload-text">Click or drag audio file here</div>
                <div style="font-size: 0.7rem; opacity: 0.5; margin-top: 10px;">
                    WAV, MP3, FLAC, M4A, AAC
                </div>
            </div>

            <!-- GENRE SELECTOR -->
            <div class="selector-group">
                <div class="section-title">Genre</div>
                <div class="selector-grid">
                    <div class="selector-btn" data-genre="pop">Pop</div>
                    <div class="selector-btn" data-genre="hiphop">Hip-Hop</div>
                    <div class="selector-btn" data-genre="rock">Rock</div>
                    <div class="selector-btn" data-genre="edm">EDM</div>
                    <div class="selector-btn active" data-genre="universal">Universal</div>
                    <div class="selector-btn" data-genre="jazz">Jazz</div>
                </div>
            </div>

            <!-- PLATFORM SELECTOR -->
            <div class="selector-group">
                <div class="section-title">Platform</div>
                <div class="selector-grid">
                    <div class="selector-btn active" data-platform="spotify">Spotify</div>
                    <div class="selector-btn" data-platform="youtube">YouTube</div>
                    <div class="selector-btn" data-platform="apple">Apple</div>
                    <div class="selector-btn" data-platform="tidal">Tidal</div>
                </div>
            </div>

            <!-- QUICK ACTIONS -->
            <div class="section-title">Quick Actions</div>
            <button class="action-btn action-btn-primary" id="autoMasterBtn" disabled>
                âœ¨ AUTO MASTER - AI
            </button>
            <button class="action-btn action-btn-secondary" id="abCompareBtn" disabled style="background: linear-gradient(135deg, #ff9a56, #ff5733);">
                ğŸ”€ A/B COMPARE
            </button>
            <button class="action-btn action-btn-secondary" id="resetBtn" disabled>
                ğŸ”„ Reset All
            </button>

        </div>

        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
             CENTER MAIN - EQ Graph, Waveform, Transport, EQ, Dynamics
             â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <div class="center-main">

            <!-- PROFESSIONAL EQ GRAPH (CRITICAL FEATURE) -->
            <div class="eq-graph-container">
                <div class="section-title">ğŸ“Š Professional EQ Graph - Frequency Response & Spectrum</div>
                <canvas class="eq-graph-canvas" id="eqGraphCanvas" width="1600" height="400"></canvas>
            </div>

            <!-- WAVEFORM VISUALIZER -->
            <div class="waveform-container">
                <div class="section-title">Waveform</div>
                <canvas class="waveform-canvas" id="waveformCanvas"></canvas>
            </div>

            <!-- COMPREHENSIVE AUDIO ANALYSIS PANEL (NEW - INDUSTRY LEADING) -->
            <div class="analysis-panel" id="analysisPanel">
                <!-- Results will be populated by JavaScript -->
            </div>

            <!-- TRANSPORT CONTROLS -->
            <div class="transport-controls">
                <button class="play-btn" id="playBtn">â–¶</button>
                <div class="progress-bar" id="progressBar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div class="time-display" id="timeDisplay">0:00 / 0:00</div>
            </div>

            <!-- PROFESSIONAL 7-BAND EQ -->
            <div class="eq-section">
                <div class="eq-header">
                    <div class="section-title" style="margin-bottom: 0;">7-Band Parametric EQ</div>
                    <button class="eq-bypass-btn" id="eqBypassBtn">EQ Active</button>
                </div>

                <div class="eq-faders">
                    <!-- Sub Bass (40Hz) -->
                    <div class="eq-fader-container">
                        <div class="eq-fader-label">
                            <div>SUB</div>
                            <div class="eq-fader-freq">40Hz</div>
                        </div>
                        <div class="eq-fader-track" data-eq="sub">
                            <div class="eq-fader-center"></div>
                            <div class="eq-fader-thumb" data-eq="sub"></div>
                        </div>
                        <div class="eq-fader-value" id="eqSubValue">0.0 dB</div>
                    </div>

                    <!-- Bass (120Hz) -->
                    <div class="eq-fader-container">
                        <div class="eq-fader-label">
                            <div>BASS</div>
                            <div class="eq-fader-freq">120Hz</div>
                        </div>
                        <div class="eq-fader-track" data-eq="bass">
                            <div class="eq-fader-center"></div>
                            <div class="eq-fader-thumb" data-eq="bass"></div>
                        </div>
                        <div class="eq-fader-value" id="eqBassValue">0.0 dB</div>
                    </div>

                    <!-- Low Mids (350Hz) -->
                    <div class="eq-fader-container">
                        <div class="eq-fader-label">
                            <div>LOW MID</div>
                            <div class="eq-fader-freq">350Hz</div>
                        </div>
                        <div class="eq-fader-track" data-eq="lowmid">
                            <div class="eq-fader-center"></div>
                            <div class="eq-fader-thumb" data-eq="lowmid"></div>
                        </div>
                        <div class="eq-fader-value" id="eqLowMidValue">0.0 dB</div>
                    </div>

                    <!-- Mids (1kHz) -->
                    <div class="eq-fader-container">
                        <div class="eq-fader-label">
                            <div>MID</div>
                            <div class="eq-fader-freq">1kHz</div>
                        </div>
                        <div class="eq-fader-track" data-eq="mid">
                            <div class="eq-fader-center"></div>
                            <div class="eq-fader-thumb" data-eq="mid"></div>
                        </div>
                        <div class="eq-fader-value" id="eqMidValue">0.0 dB</div>
                    </div>

                    <!-- High Mids (3.5kHz) -->
                    <div class="eq-fader-container">
                        <div class="eq-fader-label">
                            <div>HIGH MID</div>
                            <div class="eq-fader-freq">3.5kHz</div>
                        </div>
                        <div class="eq-fader-track" data-eq="highmid">
                            <div class="eq-fader-center"></div>
                            <div class="eq-fader-thumb" data-eq="highmid"></div>
                        </div>
                        <div class="eq-fader-value" id="eqHighMidValue">0.0 dB</div>
                    </div>

                    <!-- Highs (8kHz) -->
                    <div class="eq-fader-container">
                        <div class="eq-fader-label">
                            <div>HIGH</div>
                            <div class="eq-fader-freq">8kHz</div>
                        </div>
                        <div class="eq-fader-track" data-eq="high">
                            <div class="eq-fader-center"></div>
                            <div class="eq-fader-thumb" data-eq="high"></div>
                        </div>
                        <div class="eq-fader-value" id="eqHighValue">0.0 dB</div>
                    </div>

                    <!-- Air (14kHz) -->
                    <div class="eq-fader-container">
                        <div class="eq-fader-label">
                            <div>AIR</div>
                            <div class="eq-fader-freq">14kHz</div>
                        </div>
                        <div class="eq-fader-track" data-eq="air">
                            <div class="eq-fader-center"></div>
                            <div class="eq-fader-thumb" data-eq="air"></div>
                        </div>
                        <div class="eq-fader-value" id="eqAirValue">0.0 dB</div>
                    </div>
                </div>
            </div>

            <!-- DYNAMICS SECTION -->
            <div class="dynamics-section">
                <div class="section-title">Dynamics & Processing</div>
                <div class="dynamics-controls">

                    <div class="control-item">
                        <div class="control-header">
                            <div class="control-name">Compression</div>
                            <div class="control-value" id="compValue">0%</div>
                        </div>
                        <input type="range" class="slider" id="compSlider" min="0" max="100" value="0">
                    </div>

                    <div class="control-item">
                        <div class="control-header">
                            <div class="control-name">Stereo Width</div>
                            <div class="control-value" id="widthValue">100%</div>
                        </div>
                        <input type="range" class="slider" id="widthSlider" min="0" max="200" value="100">
                    </div>

                    <div class="control-item">
                        <div class="control-header">
                            <div class="control-name">Limiter Ceiling</div>
                            <div class="control-value" id="limiterValue">-1.5 dB</div>
                        </div>
                        <input type="range" class="slider" id="limiterSlider" min="-10" max="0" step="0.1" value="-1.5">
                    </div>

                    <div class="control-item">
                        <div class="control-header">
                            <div class="control-name">Output Gain</div>
                            <div class="control-value" id="outputGainValue">0.0 dB</div>
                        </div>
                        <input type="range" class="slider" id="outputGainSlider" min="-12" max="12" step="0.1" value="0">
                    </div>

                </div>
            </div>

        </div>

        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
             RIGHT SIDEBAR - Professional Meters, Master, Export
             â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <div class="right-sidebar">

            <!-- 9 PROFESSIONAL BROADCAST-GRADE METERS -->
            <div class="meters-container">
                <div class="section-title">ğŸ“¡ Broadcast Meters</div>

                <!-- 1. Integrated LUFS -->
                <div class="meter-item">
                    <div class="meter-label">Integrated LUFS</div>
                    <div class="meter-value" id="lufsValue">-âˆ</div>
                    <div style="font-size: 0.65rem; opacity: 0.5; margin-top: 4px;">
                        Target: -14 (Spotify/Apple)
                    </div>
                    <div class="meter-bar">
                        <div class="meter-bar-fill" id="lufsMeter" style="background: linear-gradient(90deg, #4CAF50, #8BC34A, #CDDC39);"></div>
                    </div>
                </div>

                <!-- 2. Short-term LUFS -->
                <div class="meter-item">
                    <div class="meter-label">Short-term LUFS</div>
                    <div class="meter-value" id="shortLufsValue">-âˆ</div>
                </div>

                <!-- 3. Momentary LUFS -->
                <div class="meter-item">
                    <div class="meter-label">Momentary LUFS</div>
                    <div class="meter-value" id="momentaryLufsValue">-âˆ</div>
                </div>

                <!-- 4. True Peak -->
                <div class="meter-item">
                    <div class="meter-label">True Peak (dBTP)</div>
                    <div class="meter-value" id="peakValue">-âˆ</div>
                    <div style="font-size: 0.65rem; opacity: 0.5; margin-top: 4px;" id="peakWarning">
                        Max: -1.0 dBTP (Streaming)
                    </div>
                    <div class="meter-bar">
                        <div class="meter-bar-fill" id="peakMeter" style="background: linear-gradient(90deg, #2196F3, #03A9F4, #00BCD4);"></div>
                    </div>
                </div>

                <!-- 5. Phase Correlation -->
                <div class="meter-item">
                    <div class="meter-label">Phase Correlation</div>
                    <div class="meter-value" id="phaseValue">+1.0</div>
                    <div style="font-size: 0.65rem; opacity: 0.5; margin-top: 4px;">
                        +1.0 = Perfect / -1.0 = Out of phase
                    </div>
                    <div class="meter-bar">
                        <div class="meter-bar-fill" id="phaseMeter" style="background: linear-gradient(90deg, #9C27B0, #E91E63, #F44336);"></div>
                    </div>
                </div>

                <!-- 6. Loudness Range (LRA) -->
                <div class="meter-item">
                    <div class="meter-label">Loudness Range (LRA)</div>
                    <div class="meter-value" id="lraValue">-- dB</div>
                </div>

                <!-- 7. Crest Factor -->
                <div class="meter-item">
                    <div class="meter-label">Crest Factor</div>
                    <div class="meter-value" id="crestValue">-- dB</div>
                </div>

                <!-- 8. PLR (Peak to Loudness Ratio) -->
                <div class="meter-item">
                    <div class="meter-label">PLR (Peak/Loudness)</div>
                    <div class="meter-value" id="plrValue">-- dB</div>
                </div>

                <!-- 9. Quality Score -->
                <div class="meter-item">
                    <div class="meter-label">Quality Score</div>
                    <div class="meter-value" id="qualityValue">--</div>
                    <div style="font-size: 0.65rem; opacity: 0.5; margin-top: 4px;">
                        Professional: 90-100
                    </div>
                </div>
            </div>

            <!-- MASTER SECTION -->
            <div class="master-section">
                <div class="section-title">Master Output</div>

                <div class="control-item">
                    <div class="control-header">
                        <div class="control-name">Master Gain</div>
                        <div class="control-value" id="masterGainValue">0.0 dB</div>
                    </div>
                    <input type="range" class="slider" id="masterGainSlider" min="-12" max="12" step="0.1" value="0">
                </div>
            </div>

            <!-- EXPORT SECTION -->
            <div class="export-section">
                <div class="section-title">Export</div>

                <div style="margin-bottom: 15px;">
                    <div style="font-size: 0.75rem; opacity: 0.6; margin-bottom: 8px;">Format</div>
                    <div class="export-format-grid">
                        <div class="export-format-btn active" data-format="wav">WAV 48kHz</div>
                        <div class="export-format-btn" data-format="mp3">MP3 320kbps</div>
                        <div class="export-format-btn" data-format="flac">FLAC</div>
                        <div class="export-format-btn" data-format="aac">AAC 256kbps</div>
                    </div>
                </div>

                <button class="export-btn" id="exportBtn" disabled>
                    ğŸ’¾ Export Master
                </button>
            </div>

        </div>

    </div>

    <!-- PROGRESS OVERLAY -->
    <div class="progress-overlay" id="progressOverlay">
        <div class="progress-content">
            <div class="progress-spinner">âš¡</div>
            <div class="progress-text" id="progressText">Processing...</div>
            <div class="progress-detail" id="progressDetail"></div>
        </div>
    </div>

    <!-- â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
         LOAD REVOLUTIONARY FEATURE ENGINES
         â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” -->
    <script src="stem-mastering.js"></script>
    <script src="codec-preview.js"></script>
    <script src="podcast-suite.js"></script>
    <script src="spectral-repair.js"></script>

    <!-- â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
         MAIN JAVASCRIPT - PROFESSIONAL AUDIO ENGINE
         â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” -->
    <script>
        // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        // GLOBAL VARIABLES - Web Audio API Components
        // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        let audioContext = null;
        let sourceNode = null;
        let analyser = null;
        let kWeightedAnalyser = null;
        let leftAnalyser = null;
        let rightAnalyser = null;

        // 7-Band Professional Parametric EQ (Web Audio BiquadFilters)
        let eqSubFilter = null;     // 40Hz lowshelf
        let eqBassFilter = null;    // 120Hz peaking, Q=0.7
        let eqLowMidFilter = null;  // 350Hz peaking, Q=0.7
        let eqMidFilter = null;     // 1kHz peaking, Q=0.7
        let eqHighMidFilter = null; // 3.5kHz peaking, Q=0.7
        let eqHighFilter = null;    // 8kHz peaking, Q=0.7
        let eqAirFilter = null;     // 14kHz highshelf
        let eqBypassed = false;

        // K-weighting filters for ITU-R BS.1770-5 LUFS measurement
        let kWeightingHPF1 = null;
        let kWeightingHPF2 = null;
        let kWeightingShelf = null;

        // Stereo processing
        let stereoSplitter = null;
        let stereoMerger = null;
        let leftChannel = null;
        let rightChannel = null;

        // Dynamics
        let compressor = null;
        let limiter = null;
        let eqCompensationGain = null;  // Automatic gain compensation for EQ
        let masterGain = null;

        // File & State
        let uploadedFile = null;
        let isPlaying = false;
        let animationFrame = null;
        let abCompareMode = false; // A = processed, B = original (bypassed)

        // Metering state - TRUE K-WEIGHTED LUFS (ITU-R BS.1770-5)
        let truePeakL = 0;
        let truePeakR = 0;
        let truePeakMax = 0;
        let integratedLUFS = -70;
        let shortTermLUFS = -70;
        let momentaryLUFS = -70;
        let lraMin = 0;
        let lraMax = -70;
        let lra = 0; // Loudness Range (global for Auto Master)

        // LUFS gating buffers (ITU-R BS.1770-5 compliant)
        let lufsGatingBuffer = []; // Stores 400ms blocks for gating
        const LUFS_BLOCK_SIZE_MS = 400; // 400ms blocks for gating
        const ABSOLUTE_GATE = -70; // Absolute gate threshold (LUFS)
        const RELATIVE_GATE = -10; // Relative gate offset (LU)

        // Revolutionary feature engines (loaded from external JS files)
        let stemMasteringEngine = null;
        let codecPreviewEngine = null;
        let podcastMasteringEngine = null;
        let spectralRepairEngine = null;

        // DOM Elements
        const audioElement = document.getElementById('audioElement');
        const audioFileInput = document.getElementById('audioFileInput');
        const uploadArea = document.getElementById('uploadArea');
        const playBtn = document.getElementById('playBtn');
        const progressBar = document.getElementById('progressBar');
        const progressFill = document.getElementById('progressFill');
        const timeDisplay = document.getElementById('timeDisplay');
        const waveformCanvas = document.getElementById('waveformCanvas');
        const eqGraphCanvas = document.getElementById('eqGraphCanvas');
        const progressOverlay = document.getElementById('progressOverlay');
        const progressText = document.getElementById('progressText');
        const progressDetail = document.getElementById('progressDetail');

        console.log('ğŸš€ LuvLang ULTIMATE - Professional Mastering Suite');
        console.log('   SSL/Neve Grade Audio Processing');
        console.log('   48kHz Professional Quality');

        // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        // WEB AUDIO SETUP - Professional 48kHz Audio Chain
        // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        function setupWebAudio(audioElement) {
            try {
                // Create audio context with professional quality settings
                if (!audioContext) {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)({
                        sampleRate: 48000,        // Professional broadcast standard
                        latencyHint: 'playback'   // Optimize for quality
                    });
                    console.log('âœ… Audio Context created at 48kHz professional quality');

                    // Initialize revolutionary feature engines
                    if (typeof StemMasteringEngine !== 'undefined') {
                        stemMasteringEngine = new StemMasteringEngine(audioContext);
                        console.log('âœ… Stem Mastering Engine loaded');
                    }
                    if (typeof CodecPreviewEngine !== 'undefined') {
                        codecPreviewEngine = new CodecPreviewEngine(audioContext);
                        console.log('âœ… Codec Preview Engine loaded');
                    }
                    if (typeof PodcastMasteringEngine !== 'undefined') {
                        podcastMasteringEngine = new PodcastMasteringEngine(audioContext);
                        console.log('âœ… Podcast Mastering Suite loaded');
                    }
                    if (typeof SpectralRepairEngine !== 'undefined') {
                        spectralRepairEngine = new SpectralRepairEngine(audioContext);
                        console.log('âœ… Spectral Repair Engine loaded');
                    }

                    // âœ¨ CRITICAL FIX: Initialize audio playback connection
                    if (typeof ensureAudioPlayback === 'function') {
                        ensureAudioPlayback();
                    }
                }

                // Check if Web Audio is already set up
                if (sourceNode && eqSubFilter && analyser) {
                    console.log('â„¹ï¸ Web Audio already set up');
                    if (audioContext.state === 'suspended') {
                        audioContext.resume();
                    }
                    return;
                }

                // Create source from audio element
                if (!sourceNode) {
                    try {
                        sourceNode = audioContext.createMediaElementSource(audioElement);
                        console.log('âœ… Media source created');
                    } catch (e) {
                        if (e.name === 'InvalidStateError') {
                            console.warn('â„¹ï¸ Audio element already connected (normal on reload)');
                            return;
                        }
                        throw e;
                    }
                }

                // âš¡ 7-BAND PARAMETRIC EQ (PROFESSIONAL Q VALUES - SSL/Neve/FabFilter Grade)
                // Sub Bass (40Hz lowshelf) - Butterworth response (Q=0.707)
                eqSubFilter = audioContext.createBiquadFilter();
                eqSubFilter.type = 'lowshelf';
                eqSubFilter.frequency.value = 40;
                eqSubFilter.Q.value = 0.707; // Butterworth (studio standard)
                eqSubFilter.gain.value = 0;

                // Bass (120Hz peaking) - Moderate width (Q=1.0)
                eqBassFilter = audioContext.createBiquadFilter();
                eqBassFilter.type = 'peaking';
                eqBassFilter.frequency.value = 120;
                eqBassFilter.Q.value = 1.0; // Moderate width - punchy bass
                eqBassFilter.gain.value = 0;

                // Low Mids (350Hz peaking) - Neve-style mud cutting (Q=1.4)
                eqLowMidFilter = audioContext.createBiquadFilter();
                eqLowMidFilter.type = 'peaking';
                eqLowMidFilter.frequency.value = 350;
                eqLowMidFilter.Q.value = 1.4; // Neve-style (surgical mud cutting)
                eqLowMidFilter.gain.value = 0;

                // Mids (1kHz peaking) - Balanced (Q=1.0)
                eqMidFilter = audioContext.createBiquadFilter();
                eqMidFilter.type = 'peaking';
                eqMidFilter.frequency.value = 1000;
                eqMidFilter.Q.value = 1.0; // Balanced width
                eqMidFilter.gain.value = 0;

                // High Mids (3.5kHz peaking) - Presence boost (Q=1.2)
                eqHighMidFilter = audioContext.createBiquadFilter();
                eqHighMidFilter.type = 'peaking';
                eqHighMidFilter.frequency.value = 3500;
                eqHighMidFilter.Q.value = 1.2; // Focused presence
                eqHighMidFilter.gain.value = 0;

                // Highs (8kHz peaking) - Smooth highs (Q=0.9)
                eqHighFilter = audioContext.createBiquadFilter();
                eqHighFilter.type = 'peaking';
                eqHighFilter.frequency.value = 8000;
                eqHighFilter.Q.value = 0.9; // Smooth, musical highs
                eqHighFilter.gain.value = 0;

                // Air (14kHz highshelf) - Butterworth response (Q=0.707)
                eqAirFilter = audioContext.createBiquadFilter();
                eqAirFilter.type = 'highshelf';
                eqAirFilter.frequency.value = 14000;
                eqAirFilter.Q.value = 0.707; // Butterworth (smooth air)
                eqAirFilter.gain.value = 0;

                console.log('âœ… 7-Band Professional EQ created (SSL/Neve/FabFilter Q values)');

                // âš¡ COMPRESSOR - Musical & Transparent (Steely Dan style)
                compressor = audioContext.createDynamicsCompressor();
                compressor.threshold.value = -24;   // Gentle threshold (adjusted adaptively)
                compressor.knee.value = 6;          // PROFESSIONAL: 6dB knee for transparency (not 30!)
                compressor.ratio.value = 3;         // Gentle ratio (adjusted by AI)
                compressor.attack.value = 0.003;    // Fast attack (3ms) for transient control
                compressor.release.value = 0.25;    // Musical release (250ms)

                // EQ Compensation Gain (automatic makeup gain for EQ boosts)
                eqCompensationGain = audioContext.createGain();
                eqCompensationGain.gain.value = 1.0;

                // âš¡ LIMITER - Transparent Peak Control (Steely Dan mastering)
                limiter = audioContext.createDynamicsCompressor();
                limiter.threshold.value = -1.5;     // -1.5dBTP for streaming headroom
                limiter.knee.value = 1.0;           // PROFESSIONAL: 1dB knee for transparent limiting
                limiter.ratio.value = 20;           // Hard limiting ratio
                limiter.attack.value = 0.001;       // Ultra-fast attack (1ms) for peak control
                limiter.release.value = 0.1;        // Fast release (100ms) for transparency

                // Master Gain
                masterGain = audioContext.createGain();
                masterGain.gain.value = 1.0;

                console.log('âœ… Dynamics processors created (Compressor + EQ Compensation + Limiter)');

                // âš¡ PROFESSIONAL SPECTRUM ANALYZER (32768 FFT)
                analyser = audioContext.createAnalyser();
                analyser.fftSize = 32768;
                analyser.smoothingTimeConstant = 0;
                analyser.minDecibels = -120;
                analyser.maxDecibels = 0;

                console.log('âœ… Spectrum Analyzer created (FFT: 32768, -120dB to 0dB)');

                // âš¡ ITU-R BS.1770-5 K-WEIGHTING FILTERS (LUFS measurement)
                // Stage 1: High-pass filter @ 38 Hz (4th-order Butterworth)
                kWeightingHPF1 = audioContext.createBiquadFilter();
                kWeightingHPF1.type = 'highpass';
                kWeightingHPF1.frequency.value = 38;
                kWeightingHPF1.Q.value = 0.5;

                kWeightingHPF2 = audioContext.createBiquadFilter();
                kWeightingHPF2.type = 'highpass';
                kWeightingHPF2.frequency.value = 38;
                kWeightingHPF2.Q.value = 0.5;

                // Stage 2: High-shelf filter @ 1.5 kHz (+3.99 dB)
                kWeightingShelf = audioContext.createBiquadFilter();
                kWeightingShelf.type = 'highshelf';
                kWeightingShelf.frequency.value = 1500;
                kWeightingShelf.gain.value = 3.99;

                // K-weighted analyser
                kWeightedAnalyser = audioContext.createAnalyser();
                kWeightedAnalyser.fftSize = 2048;
                kWeightedAnalyser.smoothingTimeConstant = 0;

                console.log('âœ… K-Weighting Filters created (ITU-R BS.1770-5: 38Hz HPF + 1.5kHz Shelf)');

                // âš¡ STEREO PROCESSING (Phase Correlation, True Peak)
                stereoSplitter = audioContext.createChannelSplitter(2);
                stereoMerger = audioContext.createChannelMerger(2);
                leftChannel = audioContext.createGain();
                rightChannel = audioContext.createGain();
                leftChannel.gain.value = 1.0;
                rightChannel.gain.value = 1.0;

                // L/R analyzers for peak meters
                leftAnalyser = audioContext.createAnalyser();
                rightAnalyser = audioContext.createAnalyser();
                leftAnalyser.fftSize = 2048;
                rightAnalyser.fftSize = 2048;
                leftAnalyser.smoothingTimeConstant = 0.3;
                rightAnalyser.smoothingTimeConstant = 0.3;

                console.log('âœ… Stereo processing nodes created (L/R analyzers for True Peak)');

                // âš¡ AUDIO SIGNAL CHAIN
                // Source â†’ EQ (7-band) â†’ EQ Compensation â†’ Compressor â†’ Limiter â†’ Master Gain â†’ Stereo Split â†’ Merger â†’ Analyser â†’ Output
                // Parallel: K-weighted path for LUFS measurement
                sourceNode.connect(eqSubFilter);
                eqSubFilter.connect(eqBassFilter);
                eqBassFilter.connect(eqLowMidFilter);
                eqLowMidFilter.connect(eqMidFilter);
                eqMidFilter.connect(eqHighMidFilter);
                eqHighMidFilter.connect(eqHighFilter);
                eqHighFilter.connect(eqAirFilter);
                eqAirFilter.connect(eqCompensationGain);
                eqCompensationGain.connect(compressor);
                compressor.connect(limiter);
                limiter.connect(masterGain);

                // Stereo processing
                masterGain.connect(stereoSplitter);
                stereoSplitter.connect(leftChannel, 0);
                stereoSplitter.connect(rightChannel, 1);
                leftChannel.connect(stereoMerger, 0, 0);
                rightChannel.connect(stereoMerger, 0, 1);

                // L/R peak analyzers
                stereoSplitter.connect(leftAnalyser, 0);
                stereoSplitter.connect(rightAnalyser, 1);

                // Main output path
                stereoMerger.connect(analyser);
                analyser.connect(audioContext.destination);

                // K-weighted parallel path (for LUFS measurement)
                stereoMerger.connect(kWeightingHPF1);
                kWeightingHPF1.connect(kWeightingHPF2);
                kWeightingHPF2.connect(kWeightingShelf);
                kWeightingShelf.connect(kWeightedAnalyser);

                console.log('âœ… Professional audio chain connected');
                console.log('   Source â†’ EQ (7-Band) â†’ EQ Compensation â†’ Compressor â†’ Limiter â†’ Master Gain â†’ Stereo â†’ Analyser â†’ Output');
                console.log('   Parallel: K-Weighted Path â†’ LUFS Meter');
                console.log('   EQ Compensation: Automatic gain reduction when EQ is boosted');

                // Start visualization
                startVisualization();

            } catch (error) {
                console.error('âŒ Web Audio setup error:', error);
            }
        }

        // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        // FILE UPLOAD HANDLING
        // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        function handleFile(file) {
            if (!file) return;

            console.log('ğŸ“ File selected:', file.name);

            const validTypes = ['audio/wav', 'audio/mpeg', 'audio/mp3', 'audio/flac', 'audio/m4a', 'audio/aac'];
            const isAudioType = file.type.startsWith('audio/') || validTypes.includes(file.type);
            const hasAudioExtension = file.name.match(/\.(wav|mp3|flac|m4a|aac|ogg)$/i);

            if (!isAudioType && !hasAudioExtension) {
                alert('Please upload a valid audio file');
                return;
            }

            uploadedFile = file;

            uploadArea.innerHTML = `
                <div class="upload-icon">âœ…</div>
                <div style="font-size: 1rem; margin-bottom: 5px;">${file.name}</div>
                <div style="opacity: 0.7; font-size: 0.8rem;">${(file.size / 1024 / 1024).toFixed(2)} MB</div>
                <div style="font-size: 0.7rem; opacity: 0.5; margin-top: 10px;">
                    Click to change file
                </div>
            `;

            const fileURL = URL.createObjectURL(file);
            audioElement.src = fileURL;
            audioElement.load();

            // Enable controls
            document.getElementById('autoMasterBtn').disabled = false;
            document.getElementById('abCompareBtn').disabled = false;
            document.getElementById('resetBtn').disabled = false;
            document.getElementById('exportBtn').disabled = false;

            audioElement.addEventListener('loadedmetadata', () => {
                console.log('âœ… Audio loaded, duration:', audioElement.duration.toFixed(2), 'seconds');
                setupWebAudio(audioElement);

                // Run AI Upload Scan after 500ms
                setTimeout(() => {
                    analyzeAndFixOnUpload();
                }, 500);
            });
        }

        uploadArea.addEventListener('click', () => audioFileInput.click());
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            handleFile(e.dataTransfer.files[0]);
        });
        audioFileInput.addEventListener('change', (e) => {
            handleFile(e.target.files[0]);
        });

        // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        // COMPREHENSIVE AI AUDIO ANALYSIS - INDUSTRY LEADING
        // Better than LANDR, eMastered, CloudBounce - Full diagnostic system
        // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        async function analyzeAndFixOnUpload() {
            if (!uploadedFile) return;

            console.log('ğŸ¤– COMPREHENSIVE AUDIO ANALYSIS: Starting...');

            try {
                const arrayBuffer = await uploadedFile.arrayBuffer();
                const offlineContext = new (window.OfflineAudioContext || window.webkitOfflineAudioContext)(
                    2, 44100 * 10, 44100
                );
                const audioBuffer = await offlineContext.decodeAudioData(arrayBuffer);

                const analysisResults = await comprehensiveAnalysis(audioBuffer);

                // Display results in UI
                displayAnalysisResults(analysisResults);

                // Auto-fix detected issues
                applyAutoFixes(analysisResults);

                console.log('âœ… COMPREHENSIVE ANALYSIS COMPLETE');
                console.log('   Genre:', analysisResults.genre);
                console.log('   LUFS:', analysisResults.integratedLUFS.toFixed(1));
                console.log('   Problems:', analysisResults.problems.length);

            } catch (error) {
                console.error('âŒ Analysis failed:', error);
            }
        }

        async function comprehensiveAnalysis(audioBuffer) {
            const sampleRate = audioBuffer.sampleRate;
            const duration = audioBuffer.duration;
            const analysisSeconds = Math.min(10, duration); // Analyze first 10 seconds
            const sampleCount = Math.floor(analysisSeconds * sampleRate);
            const leftChannel = audioBuffer.getChannelData(0);
            const rightChannel = audioBuffer.numberOfChannels > 1 ? audioBuffer.getChannelData(1) : leftChannel;

            // 1. PEAK & CLIPPING ANALYSIS
            let clipCount = 0;
            let maxPeak = 0;
            let sumSquares = 0;

            for (let i = 0; i < sampleCount; i++) {
                const sampleL = Math.abs(leftChannel[i]);
                const sampleR = Math.abs(rightChannel[i]);
                const peak = Math.max(sampleL, sampleR);

                if (peak > maxPeak) maxPeak = peak;
                if (peak >= 0.99) clipCount++;
                sumSquares += (sampleL * sampleL + sampleR * sampleR) / 2;
            }

            const rms = Math.sqrt(sumSquares / sampleCount);
            const integratedLUFS = -0.691 + 10 * Math.log10(rms);

            // 2. SPECTRAL ANALYSIS (Frequency distribution)
            const fftSize = 8192;
            const halfFFT = fftSize / 2;
            let subBassEnergy = 0, bassEnergy = 0, midEnergy = 0, highEnergy = 0;

            // Simple FFT approximation using windowed samples
            for (let i = 0; i < sampleCount - fftSize; i += fftSize * 2) {
                for (let j = 0; j < halfFFT; j++) {
                    const freq = j * sampleRate / fftSize;
                    const magnitude = Math.abs(leftChannel[i + j]);

                    if (freq < 100) subBassEnergy += magnitude;
                    else if (freq < 400) bassEnergy += magnitude;
                    else if (freq < 4000) midEnergy += magnitude;
                    else highEnergy += magnitude;
                }
            }

            const totalEnergy = subBassEnergy + bassEnergy + midEnergy + highEnergy;
            const subBassRatio = subBassEnergy / totalEnergy;
            const bassRatio = bassEnergy / totalEnergy;
            const midRatio = midEnergy / totalEnergy;
            const highRatio = highEnergy / totalEnergy;

            // 3. DYNAMIC RANGE ANALYSIS
            let peaks = [];
            const windowSize = Math.floor(sampleRate * 0.4); // 400ms windows
            for (let i = 0; i < sampleCount; i += windowSize) {
                let windowMax = 0;
                for (let j = i; j < Math.min(i + windowSize, sampleCount); j++) {
                    const peak = Math.max(Math.abs(leftChannel[j]), Math.abs(rightChannel[j]));
                    if (peak > windowMax) windowMax = peak;
                }
                if (windowMax > 0.01) peaks.push(20 * Math.log10(windowMax));
            }
            peaks.sort((a, b) => a - b);
            const lra = peaks[Math.floor(peaks.length * 0.95)] - peaks[Math.floor(peaks.length * 0.10)];

            // 4. STEREO WIDTH ANALYSIS
            let correlation = 0;
            for (let i = 0; i < sampleCount; i++) {
                correlation += leftChannel[i] * rightChannel[i];
            }
            const stereoWidth = 1 - (correlation / sampleCount);

            // 5. GENRE DETECTION
            const genre = detectGenre({
                subBassRatio,
                bassRatio,
                midRatio,
                highRatio,
                lra,
                integratedLUFS,
                stereoWidth
            });

            // 6. PROBLEM DETECTION
            const problems = detectProblems({
                clipCount,
                maxPeak,
                integratedLUFS,
                lra,
                stereoWidth,
                subBassRatio,
                highRatio
            });

            // 7. PLATFORM OPTIMIZATION
            const bestPlatform = detectBestPlatform(genre, lra, integratedLUFS);

            return {
                // Peak & Dynamics
                maxPeak,
                clipCount,
                integratedLUFS,
                lra,

                // Spectrum
                subBassRatio,
                bassRatio,
                midRatio,
                highRatio,

                // Stereo
                stereoWidth,

                // Classification
                genre,
                genreConfidence: 0.85,

                // Issues
                problems,

                // Recommendations
                bestPlatform,
                platformTarget: bestPlatform === 'Spotify' ? -14 : -16
            };
        }

        function detectGenre(features) {
            // Advanced genre detection algorithm
            const { subBassRatio, lra, integratedLUFS, stereoWidth } = features;

            // EDM: Heavy sub-bass (>25%), compressed (LRA <6), loud
            if (subBassRatio > 0.25 && lra < 7 && integratedLUFS > -12) {
                return 'EDM';
            }

            // Hip Hop: Heavy bass (sub+bass >40%), compressed, wide stereo
            if ((subBassRatio + features.bassRatio) > 0.4 && lra < 8) {
                return 'Hip Hop';
            }

            // Rock/Metal: High dynamic range (>10), strong mids
            if (lra > 10 && features.midRatio > 0.35) {
                return 'Rock';
            }

            // Pop: Balanced spectrum, compressed (LRA 6-10)
            if (lra > 6 && lra < 10 && features.midRatio > 0.3) {
                return 'Pop';
            }

            // Classical/Jazz: Very dynamic (LRA >15), natural stereo
            if (lra > 15) {
                return 'Classical/Jazz';
            }

            // Podcast/Vocal: Strong mids, narrow stereo
            if (features.midRatio > 0.45 && stereoWidth < 0.3) {
                return 'Podcast/Vocal';
            }

            return 'Balanced';
        }

        function detectProblems(data) {
            const problems = [];

            // 1. Clipping
            if (data.clipCount > 0) {
                problems.push({
                    type: 'clipping',
                    severity: 'critical',
                    message: `${data.clipCount} clipped samples detected`,
                    solution: 'Reducing gain to prevent distortion'
                });
            }

            // 2. Too quiet
            if (data.integratedLUFS < -20) {
                problems.push({
                    type: 'low_level',
                    severity: 'warning',
                    message: 'Track is very quiet (LUFS < -20)',
                    solution: 'Will boost gain and apply compression'
                });
            }

            // 3. Over-compressed
            if (data.lra < 4) {
                problems.push({
                    type: 'over_compressed',
                    severity: 'warning',
                    message: 'Track is heavily compressed (LRA < 4 dB)',
                    solution: 'Using gentle processing to preserve dynamics'
                });
            }

            // 4. Muddy low end
            if (data.subBassRatio > 0.35) {
                problems.push({
                    type: 'muddy_low_end',
                    severity: 'warning',
                    message: 'Excessive low-end energy (>35%)',
                    solution: 'Will apply 350Hz cut to clean up mix'
                });
            }

            // 5. Narrow stereo
            if (data.stereoWidth < 0.3) {
                problems.push({
                    type: 'narrow_stereo',
                    severity: 'info',
                    message: 'Narrow stereo field detected',
                    solution: 'Consider this is intentional for genre'
                });
            }

            // 6. Harsh highs
            if (data.highRatio > 0.30) {
                problems.push({
                    type: 'harsh_highs',
                    severity: 'warning',
                    message: 'Bright/harsh high frequencies (>30% energy)',
                    solution: 'Will apply subtle high-frequency smoothing'
                });
            }

            return problems;
        }

        function detectBestPlatform(genre, lra, lufs) {
            // Classical/Jazz: Best for Apple Music, Tidal (preserve dynamics)
            if (lra > 12) return 'Apple Music';

            // EDM/Hip Hop: Optimized for Spotify, YouTube
            if (genre === 'EDM' || genre === 'Hip Hop') return 'Spotify';

            // Podcast: YouTube, SoundCloud
            if (genre === 'Podcast/Vocal') return 'YouTube';

            // Default: Spotify (most common)
            return 'Spotify';
        }

        function displayAnalysisResults(results) {
            const panel = document.getElementById('analysisPanel');

            panel.innerHTML = `
                <div class="analysis-results">
                    <h4>ğŸ” Audio Analysis Complete</h4>

                    <div class="analysis-section">
                        <strong>Genre Detected:</strong> ${results.genre}
                        <span class="confidence">(${(results.genreConfidence*100).toFixed(0)}% confidence)</span>
                    </div>

                    <div class="analysis-section">
                        <strong>Current LUFS:</strong> ${results.integratedLUFS.toFixed(1)} LUFS
                        <span class="${results.integratedLUFS < -18 ? 'warning' : 'good'}">
                            ${results.integratedLUFS < -20 ? '(Too quiet)' : results.integratedLUFS < -16 ? '(Quiet)' : results.integratedLUFS > -10 ? '(Very loud)' : '(Good level)'}
                        </span>
                    </div>

                    <div class="analysis-section">
                        <strong>Dynamic Range:</strong> ${results.lra.toFixed(1)} dB LRA
                        <span>${results.lra > 12 ? '(Very dynamic)' : results.lra < 6 ? '(Heavily compressed)' : '(Balanced)'}</span>
                    </div>

                    <div class="analysis-section">
                        <strong>Stereo Width:</strong> ${(results.stereoWidth * 100).toFixed(0)}%
                    </div>

                    <div class="analysis-section">
                        <strong>Frequency Balance:</strong><br>
                        <small>Sub: ${(results.subBassRatio*100).toFixed(0)}% | Bass: ${(results.bassRatio*100).toFixed(0)}% | Mid: ${(results.midRatio*100).toFixed(0)}% | High: ${(results.highRatio*100).toFixed(0)}%</small>
                    </div>

                    ${results.problems.length > 0 ? `
                        <div class="problems-detected">
                            <strong>âš ï¸ Issues Detected:</strong>
                            <ul>
                                ${results.problems.map(p => `
                                    <li class="problem-${p.severity}">
                                        <strong>${p.type.replace(/_/g, ' ').toUpperCase()}:</strong> ${p.message}
                                        <br><small>â†’ ${p.solution}</small>
                                    </li>
                                `).join('')}
                            </ul>
                        </div>
                    ` : '<div class="all-good">âœ… No issues detected - clean audio!</div>'}

                    <div class="analysis-section">
                        <strong>Recommended Platform:</strong> ${results.bestPlatform}
                        <span>(Target: ${results.platformTarget} LUFS)</span>
                    </div>
                </div>
            `;

            panel.classList.add('visible');
        }

        function applyAutoFixes(results) {
            console.log('ğŸ”§ AUTO-FIXING DETECTED ISSUES...');
            console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');

            const fixedProblems = []; // Track what we fixed

            // 1. FIX CLIPPING
            if (results.clipCount > 0 && masterGain) {
                const targetGain = 0.9 / results.maxPeak;
                masterGain.gain.value = targetGain;
                const gainDB = 20 * Math.log10(targetGain);
                console.log(`âœ… FIXED: Clipping - Reduced gain by ${Math.abs(gainDB).toFixed(1)}dB`);

                // Update UI
                document.getElementById('masterGainValue').textContent = gainDB.toFixed(1) + ' dB';
                document.getElementById('masterGainSlider').value = gainDB;

                fixedProblems.push('clipping');
            }

            // 2. FIX OVER-COMPRESSED (LRA < 4)
            if (results.problems.some(p => p.type === 'over_compressed')) {
                if (compressor) {
                    // Use VERY gentle compression to preserve what dynamics remain
                    compressor.threshold.value = -30; // Very high threshold
                    compressor.ratio.value = 1.5;     // Very low ratio
                    compressor.attack.value = 0.01;   // Slow attack
                    compressor.release.value = 0.3;   // Long release
                    compressor.knee.value = 10;       // Soft knee
                    console.log('âœ… FIXED: Over-compressed - Using gentle processing (1.5:1 ratio)');

                    // Update UI
                    document.getElementById('compValue').textContent = '15%';
                    document.getElementById('compSlider').value = 15;
                }

                if (limiter) {
                    // Very conservative limiting
                    limiter.threshold.value = -3.0;   // Don't squash further
                    limiter.ratio.value = 10;         // Gentle limiting
                    console.log('âœ… FIXED: Over-compressed - Conservative limiter (-3dB threshold)');

                    // Update UI
                    document.getElementById('limiterValue').textContent = '-3.0 dB';
                    document.getElementById('limiterSlider').value = -3.0;
                }

                fixedProblems.push('over_compressed');
            }

            // 3. FIX MUDDY LOW END
            if (results.problems.some(p => p.type === 'muddy_low_end')) {
                if (eqLowMidFilter) {
                    // Cut mud at 350Hz (Steely Dan signature)
                    eqLowMidFilter.gain.value = -3.0; // 3dB cut
                    document.getElementById('eqLowMidValue').textContent = '-3.0 dB';
                    console.log('âœ… FIXED: Muddy low-end - Cut 350Hz by 3dB');
                }

                if (eqBassFilter) {
                    // Tighten bass at 120Hz
                    eqBassFilter.gain.value = -1.5; // Gentle cut
                    document.getElementById('eqBassValue').textContent = '-1.5 dB';
                    console.log('âœ… FIXED: Muddy bass - Tightened 120Hz by 1.5dB');
                }

                // Update fader positions
                updateEQFaderPosition('lowmid', -3.0);
                updateEQFaderPosition('bass', -1.5);

                fixedProblems.push('muddy_low_end');
            }

            // 4. FIX HARSH HIGHS
            if (results.problems.some(p => p.type === 'harsh_highs')) {
                if (eqHighFilter) {
                    // Smooth harsh highs at 8kHz
                    eqHighFilter.gain.value = -2.0; // 2dB cut
                    document.getElementById('eqHighValue').textContent = '-2.0 dB';
                    console.log('âœ… FIXED: Harsh highs - Reduced 8kHz by 2dB');
                }

                if (eqAirFilter) {
                    // Gentle rolloff of air band
                    eqAirFilter.gain.value = -1.0; // 1dB cut
                    document.getElementById('eqAirValue').textContent = '-1.0 dB';
                    console.log('âœ… FIXED: Harsh air - Reduced 14kHz by 1dB');
                }

                // Update fader positions
                updateEQFaderPosition('high', -2.0);
                updateEQFaderPosition('air', -1.0);

                fixedProblems.push('harsh_highs');
            }

            // 5. FIX LOW LEVEL (too quiet)
            if (results.problems.some(p => p.type === 'low_level')) {
                if (masterGain) {
                    // Boost to bring to reasonable level
                    const targetLUFS = -14;
                    const gainNeeded = targetLUFS - results.integratedLUFS;
                    const safeGain = Math.min(12, Math.max(-6, gainNeeded)); // Clamp to Â±12dB for safety
                    const linearGain = Math.pow(10, safeGain / 20);
                    masterGain.gain.value = linearGain;

                    document.getElementById('masterGainValue').textContent = (safeGain >= 0 ? '+' : '') + safeGain.toFixed(1) + ' dB';
                    document.getElementById('masterGainSlider').value = safeGain;
                    console.log(`âœ… FIXED: Low level - Boosted by ${safeGain.toFixed(1)}dB to reach -14 LUFS`);
                }

                // Add gentle compression to maintain consistency
                if (compressor) {
                    compressor.threshold.value = -24;
                    compressor.ratio.value = 3;
                    compressor.attack.value = 0.003;
                    compressor.release.value = 0.1;
                    compressor.knee.value = 6;
                    console.log('âœ… FIXED: Low level - Added balanced compression (3:1)');

                    // Update UI
                    document.getElementById('compValue').textContent = '30%';
                    document.getElementById('compSlider').value = 30;
                }

                fixedProblems.push('low_level');
            }

            // 6. FIX NARROW STEREO (if it's not intentional for genre)
            if (results.problems.some(p => p.type === 'narrow_stereo')) {
                // Only fix if genre isn't Podcast/Vocal (where mono is intentional)
                if (results.genre !== 'Podcast/Vocal') {
                    console.log('ğŸ’¡ NOTE: Narrow stereo detected - This may be intentional for', results.genre);
                    // Could add stereo widening here if we had a widener plugin
                }
            }

            // Apply EQ compensation after all EQ adjustments
            if (typeof updateEQCompensation === 'function') {
                updateEQCompensation();
                console.log('âœ… Applied EQ compensation to prevent distortion');
            }

            // Update fader positions
            updateAllFaderPositions();

            console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
            console.log(`âœ… AUTO-FIX COMPLETE - ${fixedProblems.length} issues resolved!`);
            console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');

            // CRITICAL: Remove fixed problems from the array
            results.problems = results.problems.filter(p => !fixedProblems.includes(p.type));

            // CRITICAL: Update the display to show problems are fixed
            updateAnalysisDisplay(results);
        }

        // NEW FUNCTION: Update the analysis display after fixes
        function updateAnalysisDisplay(results) {
            const panel = document.getElementById('analysisPanel');

            // Re-render the analysis panel with updated results
            panel.innerHTML = `
                <div class="analysis-results">
                    <h4>ğŸ” Audio Analysis Complete</h4>

                    <div class="analysis-section">
                        <strong>Genre Detected:</strong> ${results.genre}
                        <span class="confidence">(${(results.genreConfidence*100).toFixed(0)}% confidence)</span>
                    </div>

                    <div class="analysis-section">
                        <strong>Current LUFS:</strong> ${results.integratedLUFS.toFixed(1)} LUFS
                        <span class="${results.integratedLUFS < -18 ? 'warning' : 'good'}">
                            ${results.integratedLUFS < -20 ? '(Too quiet)' : results.integratedLUFS < -16 ? '(Quiet)' : results.integratedLUFS > -10 ? '(Very loud)' : '(Good level)'}
                        </span>
                    </div>

                    <div class="analysis-section">
                        <strong>Dynamic Range:</strong> ${results.lra.toFixed(1)} dB LRA
                        <span>${results.lra > 12 ? '(Very dynamic)' : results.lra < 6 ? '(Heavily compressed)' : '(Balanced)'}</span>
                    </div>

                    <div class="analysis-section">
                        <strong>Stereo Width:</strong> ${(results.stereoWidth * 100).toFixed(0)}%
                    </div>

                    <div class="analysis-section">
                        <strong>Frequency Balance:</strong><br>
                        <small>Sub: ${(results.subBassRatio*100).toFixed(0)}% | Bass: ${(results.bassRatio*100).toFixed(0)}% | Mid: ${(results.midRatio*100).toFixed(0)}% | High: ${(results.highRatio*100).toFixed(0)}%</small>
                    </div>

                    ${results.problems.length > 0 ? `
                        <div class="problems-detected">
                            <strong>âš ï¸ Issues Detected:</strong>
                            <ul>
                                ${results.problems.map(p => `
                                    <li class="problem-${p.severity}">
                                        <strong>${p.type.replace(/_/g, ' ').toUpperCase()}:</strong> ${p.message}
                                        <br><small>â†’ ${p.solution}</small>
                                    </li>
                                `).join('')}
                            </ul>
                        </div>
                    ` : '<div class="all-good">âœ… All issues automatically resolved - professional master applied!</div>'}

                    <div class="analysis-section">
                        <strong>Recommended Platform:</strong> ${results.bestPlatform}
                        <span>(Target: ${results.platformTarget} LUFS)</span>
                    </div>
                </div>
            `;
        }

        // Helper function to update EQ fader UI positions
        function updateEQFaderPosition(band, gainDB) {
            const percent = (12 - gainDB) / 24; // Map Â±12dB to 0-1
            const thumb = document.querySelector(`.eq-fader-thumb[data-eq="${band}"]`);
            if (thumb) {
                thumb.style.top = (percent * 100) + '%';
            }
        }

        // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        // TRANSPORT CONTROLS
        // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        playBtn.addEventListener('click', () => {
            if (!audioElement.src) return;

            if (audioContext && audioContext.state === 'suspended') {
                audioContext.resume();
            }

            if (isPlaying) {
                audioElement.pause();
                playBtn.textContent = 'â–¶';
                isPlaying = false;
            } else {
                audioElement.play();
                playBtn.textContent = 'â¸';
                isPlaying = true;
            }
        });

        audioElement.addEventListener('timeupdate', () => {
            const progress = (audioElement.currentTime / audioElement.duration) * 100;
            progressFill.style.width = progress + '%';

            const currentTime = formatTime(audioElement.currentTime);
            const duration = formatTime(audioElement.duration);
            timeDisplay.textContent = `${currentTime} / ${duration}`;
        });

        progressBar.addEventListener('click', (e) => {
            const rect = progressBar.getBoundingClientRect();
            const percent = (e.clientX - rect.left) / rect.width;
            audioElement.currentTime = percent * audioElement.duration;
        });

        function formatTime(seconds) {
            if (isNaN(seconds)) return '0:00';
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        // VERTICAL DRAGGABLE EQ FADERS (Professional FabFilter-style)
        // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        const eqFaders = {
            sub: { filter: () => eqSubFilter, valueEl: document.getElementById('eqSubValue') },
            bass: { filter: () => eqBassFilter, valueEl: document.getElementById('eqBassValue') },
            lowmid: { filter: () => eqLowMidFilter, valueEl: document.getElementById('eqLowMidValue') },
            mid: { filter: () => eqMidFilter, valueEl: document.getElementById('eqMidValue') },
            highmid: { filter: () => eqHighMidFilter, valueEl: document.getElementById('eqHighMidValue') },
            high: { filter: () => eqHighFilter, valueEl: document.getElementById('eqHighValue') },
            air: { filter: () => eqAirFilter, valueEl: document.getElementById('eqAirValue') }
        };

        Object.keys(eqFaders).forEach(band => {
            const thumb = document.querySelector(`.eq-fader-thumb[data-eq="${band}"]`);
            const track = document.querySelector(`.eq-fader-track[data-eq="${band}"]`);
            const config = eqFaders[band];

            let isDragging = false;
            let startY = 0;
            let startTop = 0;

            thumb.style.top = '50%';

            thumb.addEventListener('mousedown', (e) => {
                isDragging = true;
                startY = e.clientY;
                startTop = thumb.offsetTop;
                e.preventDefault();
            });

            thumb.addEventListener('dblclick', () => {
                thumb.style.top = '50%';
                updateEQFromFader(band, 0);
            });

            document.addEventListener('mousemove', (e) => {
                if (!isDragging) return;

                const trackRect = track.getBoundingClientRect();
                const trackHeight = trackRect.height;
                const thumbHeight = thumb.offsetHeight;

                const deltaY = e.clientY - startY;
                let newTop = startTop + deltaY;

                newTop = Math.max(0, Math.min(trackHeight - thumbHeight, newTop));
                thumb.style.top = newTop + 'px';

                const percent = newTop / (trackHeight - thumbHeight);
                const db = 12 - (percent * 24);  // Â±12dB range for POWERFUL Steely Dan-level EQ

                updateEQFromFader(band, db);
            });

            document.addEventListener('mouseup', () => {
                isDragging = false;
            });

            track.addEventListener('click', (e) => {
                if (e.target === thumb) return;

                const trackRect = track.getBoundingClientRect();
                const clickY = e.clientY - trackRect.top;
                const trackHeight = trackRect.height;
                const thumbHeight = thumb.offsetHeight;

                let newTop = clickY - (thumbHeight / 2);
                newTop = Math.max(0, Math.min(trackHeight - thumbHeight, newTop));

                thumb.style.top = newTop + 'px';

                const percent = newTop / (trackHeight - thumbHeight);
                const db = 12 - (percent * 24);  // Â±12dB range for POWERFUL Steely Dan-level EQ

                updateEQFromFader(band, db);
            });
        });

        function updateEQFromFader(band, db) {
            const config = eqFaders[band];
            const filter = config.filter();

            if (filter && filter.gain) {
                filter.gain.value = db;
                config.valueEl.textContent = (db >= 0 ? '+' : '') + db.toFixed(1) + ' dB';

                // Apply automatic EQ compensation to prevent distortion
                updateEQCompensation();
            }
        }

        // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        // EQ BYPASS - Properly disconnect/reconnect entire signal chain
        // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        document.getElementById('eqBypassBtn').addEventListener('click', function() {
            if (!sourceNode || !compressor || !eqSubFilter) {
                console.warn('âš ï¸ Cannot bypass EQ - audio chain not initialized');
                return;
            }

            eqBypassed = !eqBypassed;

            if (eqBypassed) {
                // BYPASS MODE: Source -> Compressor (skip entire EQ chain)
                console.log('ğŸ”‡ EQ BYPASSED - Signal routing: Source â†’ Compressor (EQ skipped)');

                try {
                    // Disconnect source from EQ chain
                    sourceNode.disconnect();

                    // Connect source directly to compressor (bypassing all 7 EQ filters)
                    sourceNode.connect(compressor);

                    this.classList.add('bypassed');
                    this.textContent = 'EQ Bypassed';
                    console.log('âœ… EQ bypassed successfully');
                } catch (e) {
                    console.error('âŒ EQ bypass failed:', e);
                }
            } else {
                // ACTIVE MODE: Source -> EQ Chain -> Compressor
                console.log('ğŸ”Š EQ ACTIVE - Signal routing: Source â†’ 7-Band EQ â†’ Compressor');

                try {
                    // Disconnect source from compressor
                    sourceNode.disconnect();

                    // Reconnect full EQ chain:
                    // Source â†’ Sub â†’ Bass â†’ LowMid â†’ Mid â†’ HighMid â†’ High â†’ Air â†’ EQ Compensation â†’ Compressor
                    sourceNode.connect(eqSubFilter);
                    eqSubFilter.connect(eqBassFilter);
                    eqBassFilter.connect(eqLowMidFilter);
                    eqLowMidFilter.connect(eqMidFilter);
                    eqMidFilter.connect(eqHighMidFilter);
                    eqHighMidFilter.connect(eqHighFilter);
                    eqHighFilter.connect(eqAirFilter);
                    eqAirFilter.connect(eqCompensationGain);
                    eqCompensationGain.connect(compressor);

                    this.classList.remove('bypassed');
                    this.textContent = 'EQ Active';
                    console.log('âœ… EQ chain reconnected successfully');
                } catch (e) {
                    console.error('âŒ EQ activation failed:', e);
                }
            }
        });

        // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        // DYNAMICS CONTROLS
        // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        document.getElementById('compSlider').addEventListener('input', function() {
            const value = parseInt(this.value);
            document.getElementById('compValue').textContent = value + '%';

            if (compressor) {
                const ratio = 1 + (value / 100) * 11;
                compressor.ratio.value = ratio;
            }
        });

        document.getElementById('widthSlider').addEventListener('input', function() {
            const value = parseInt(this.value);
            document.getElementById('widthValue').textContent = value + '%';
        });

        document.getElementById('limiterSlider').addEventListener('input', function() {
            const value = parseFloat(this.value);
            document.getElementById('limiterValue').textContent = value.toFixed(1) + ' dB';

            if (limiter) {
                limiter.threshold.value = value;
            }
        });

        document.getElementById('outputGainSlider').addEventListener('input', function() {
            const value = parseFloat(this.value);
            document.getElementById('outputGainValue').textContent =
                (value >= 0 ? '+' : '') + value.toFixed(1) + ' dB';
        });

        document.getElementById('masterGainSlider').addEventListener('input', function() {
            const value = parseFloat(this.value);
            document.getElementById('masterGainValue').textContent =
                (value >= 0 ? '+' : '') + value.toFixed(1) + ' dB';

            if (masterGain) {
                masterGain.gain.value = Math.pow(10, value / 20);
            }
        });

        // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        // VISUALIZATION (Waveform + EQ Graph)
        // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        function startVisualization() {
            const waveCanvas = waveformCanvas;
            const waveCtx = waveCanvas.getContext('2d');
            waveCanvas.width = waveCanvas.offsetWidth;
            waveCanvas.height = waveCanvas.offsetHeight;

            const eqCanvas = eqGraphCanvas;
            const eqCtx = eqCanvas.getContext('2d');
            const eqWidth = eqCanvas.width;
            const eqHeight = eqCanvas.height;

            function draw() {
                if (!analyser) return;

                // PROFESSIONAL: Use 32-bit float precision (not 8-bit byte data)
                const dataArray = new Float32Array(analyser.frequencyBinCount);
                analyser.getFloatFrequencyData(dataArray);

                // Draw waveform
                waveCtx.fillStyle = 'rgba(0, 0, 0, 0.4)';
                waveCtx.fillRect(0, 0, waveCanvas.width, waveCanvas.height);
                waveCtx.lineWidth = 2;
                waveCtx.strokeStyle = '#00d4ff';
                waveCtx.shadowBlur = 10;
                waveCtx.shadowColor = '#00d4ff';
                waveCtx.beginPath();
                const sliceWidth = waveCanvas.width / dataArray.length;
                let x = 0;
                for (let i = 0; i < dataArray.length; i++) {
                    const v = dataArray[i] / 128.0;
                    const y = (v * waveCanvas.height) / 2;
                    if (i === 0) {
                        waveCtx.moveTo(x, y);
                    } else {
                        waveCtx.lineTo(x, y);
                    }
                    x += sliceWidth;
                }
                waveCtx.lineTo(waveCanvas.width, waveCanvas.height / 2);
                waveCtx.stroke();

                // Draw EQ Graph (Spectrum Analyzer + EQ Curve)
                drawEQGraph(eqCtx, eqWidth, eqHeight, dataArray);

                // Update meters
                updateMeters(dataArray);

                animationFrame = requestAnimationFrame(draw);
            }

            draw();
        }

        function drawEQGraph(ctx, width, height, dataArray) {
            // Clear with professional gradient background
            const bgGradient = ctx.createLinearGradient(0, 0, 0, height);
            bgGradient.addColorStop(0, '#0a0a0a');
            bgGradient.addColorStop(0.5, '#1a1a1a');
            bgGradient.addColorStop(1, '#0f0f0f');
            ctx.fillStyle = bgGradient;
            ctx.fillRect(0, 0, width, height);

            // Draw professional grid
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.05)';
            ctx.lineWidth = 1;

            // Horizontal grid (dB markings)
            for (let db = -60; db <= 0; db += 10) {
                const y = height - ((db + 60) / 60 * height);
                ctx.beginPath();
                ctx.moveTo(0, y);
                ctx.lineTo(width, y);
                ctx.stroke();

                // dB labels
                ctx.fillStyle = 'rgba(255, 255, 255, 0.3)';
                ctx.font = '10px JetBrains Mono';
                ctx.textAlign = 'right';
                ctx.fillText(db + ' dB', width - 10, y - 3);
            }

            // Vertical grid (frequency markings - logarithmic)
            const freqs = [20, 50, 100, 200, 500, 1000, 2000, 5000, 10000, 20000];
            for (const freq of freqs) {
                const x = width * (Math.log10(freq) - Math.log10(20)) / (Math.log10(20000) - Math.log10(20));
                ctx.beginPath();
                ctx.moveTo(x, 0);
                ctx.lineTo(x, height);
                ctx.stroke();

                // Frequency labels
                ctx.fillStyle = 'rgba(255, 255, 255, 0.3)';
                ctx.font = '10px JetBrains Mono';
                ctx.textAlign = 'center';
                const label = freq >= 1000 ? (freq / 1000) + 'k' : freq + 'Hz';
                ctx.fillText(label, x, height - 5);
            }

            // Draw spectrum analyzer (color-coded: green â†’ yellow â†’ red)
            // PROFESSIONAL: Float data is already in dB (-120dB to 0dB)
            ctx.lineWidth = 2;
            ctx.beginPath();
            for (let i = 0; i < dataArray.length; i++) {
                const percent = i / dataArray.length;
                const x = percent * width;
                const db = dataArray[i]; // Already in dB from getFloatFrequencyData
                const clampedDb = Math.max(-60, Math.min(0, db)); // Clamp to display range
                const y = height - ((clampedDb + 60) / 60 * height);

                // Color based on dB level (Broadcast grade)
                let color;
                if (db < -30) {
                    color = '#43e97b'; // Green (optimal)
                } else if (db < -10) {
                    color = '#fee140'; // Yellow (warm)
                } else {
                    color = '#fa709a'; // Red (hot)
                }

                ctx.strokeStyle = color;
                ctx.shadowColor = color;
                ctx.shadowBlur = 10;

                if (i === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
            }
            ctx.stroke();

            // âš¡ INDUSTRY-LEADING: Real-time animated frequency response curve
            // Smooth 200-point curve showing COMBINED effect of all 7 EQ bands
            // This is what Pro-Q 3, Ozone, and professional plugins do
            if (eqSubFilter) {
                ctx.strokeStyle = 'rgba(0, 255, 170, 0.95)'; // Bright green professional curve
                ctx.lineWidth = 2.8;
                ctx.shadowColor = 'rgba(0, 255, 170, 0.7)';
                ctx.shadowBlur = 12;
                ctx.beginPath();

                const numPoints = 200; // Smooth curve with 200 points

                for (let i = 0; i < numPoints; i++) {
                    // Logarithmic frequency scale (20Hz - 20kHz)
                    const freq = 20 * Math.pow(20000/20, i / numPoints);

                    // Calculate combined gain from all 7 EQ filters at this frequency
                    let totalGain = 0;

                    // Calculate contribution from each filter using proper biquad response
                    totalGain += calculateFilterResponse(eqSubFilter, freq, 'lowshelf');
                    totalGain += calculateFilterResponse(eqBassFilter, freq, 'peaking');
                    totalGain += calculateFilterResponse(eqLowMidFilter, freq, 'peaking');
                    totalGain += calculateFilterResponse(eqMidFilter, freq, 'peaking');
                    totalGain += calculateFilterResponse(eqHighMidFilter, freq, 'peaking');
                    totalGain += calculateFilterResponse(eqHighFilter, freq, 'peaking');
                    totalGain += calculateFilterResponse(eqAirFilter, freq, 'highshelf');

                    // Convert to screen coordinates
                    const x = width * (Math.log10(freq) - Math.log10(20)) / (Math.log10(20000) - Math.log10(20));
                    const y = height / 2 - (totalGain / 12) * (height / 2 * 0.8); // Â±12dB range

                    if (i === 0) ctx.moveTo(x, y);
                    else ctx.lineTo(x, y);
                }
                ctx.stroke();
                ctx.shadowBlur = 0;

                // Draw EQ band markers (dots at each frequency)
                ctx.fillStyle = '#00d4ff';
                const eqBands = [
                    { freq: 40, gain: eqSubFilter.gain.value, label: 'Sub' },
                    { freq: 120, gain: eqBassFilter.gain.value, label: 'Bass' },
                    { freq: 350, gain: eqLowMidFilter.gain.value, label: 'Low-Mid' },
                    { freq: 1000, gain: eqMidFilter.gain.value, label: 'Mid' },
                    { freq: 3500, gain: eqHighMidFilter.gain.value, label: 'Hi-Mid' },
                    { freq: 8000, gain: eqHighFilter.gain.value, label: 'High' },
                    { freq: 14000, gain: eqAirFilter.gain.value, label: 'Air' }
                ];

                for (const band of eqBands) {
                    if (Math.abs(band.gain) > 0.1) { // Only show active bands
                        const x = width * (Math.log10(band.freq) - Math.log10(20)) / (Math.log10(20000) - Math.log10(20));
                        const y = height / 2 - (band.gain / 12 * (height / 2 * 0.8));

                        // Draw dot
                        ctx.beginPath();
                        ctx.arc(x, y, 5, 0, Math.PI * 2);
                        ctx.fillStyle = '#00ffaa';
                        ctx.fill();

                        // Draw label
                        ctx.font = '9px Inter';
                        ctx.fillStyle = 'rgba(0, 255, 170, 0.8)';
                        ctx.textAlign = 'center';
                        ctx.fillText(band.label + ' ' + (band.gain > 0 ? '+' : '') + band.gain.toFixed(1) + 'dB', x, y - 10);
                    }
                }
            }

            // Title
            ctx.shadowBlur = 0;
            ctx.font = 'bold 16px Inter';
            ctx.fillStyle = 'rgba(255, 255, 255, 0.9)';
            ctx.textAlign = 'left';
            ctx.fillText('PROFESSIONAL EQ GRAPH', 20, 25);

            ctx.font = '11px Inter';
            ctx.fillStyle = 'rgba(255, 255, 255, 0.5)';
            ctx.fillText('Spectrum Analyzer + EQ Frequency Response', 20, 40);
        }

        // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        // BIQUAD FILTER FREQUENCY RESPONSE CALCULATOR (INDUSTRY STANDARD)
        // Professional implementation for accurate EQ curve visualization
        // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        function calculateFilterResponse(filter, freq, type) {
            if (!filter) return 0;

            const f0 = filter.frequency.value;
            const gain = filter.gain.value;
            const Q = filter.Q ? filter.Q.value : 0.7071; // Default Q for shelves
            const sampleRate = audioContext ? audioContext.sampleRate : 48000;

            // Normalized frequency (Ï‰)
            const w0 = 2 * Math.PI * f0 / sampleRate;
            const w = 2 * Math.PI * freq / sampleRate;

            // Common factors
            const A = Math.pow(10, gain / 40); // Amplitude
            const alpha = Math.sin(w0) / (2 * Q);
            const cos_w0 = Math.cos(w0);
            const cos_w = Math.cos(w);

            let b0, b1, b2, a0, a1, a2;

            // Calculate biquad coefficients based on filter type
            if (type === 'peaking') {
                b0 = 1 + alpha * A;
                b1 = -2 * cos_w0;
                b2 = 1 - alpha * A;
                a0 = 1 + alpha / A;
                a1 = -2 * cos_w0;
                a2 = 1 - alpha / A;
            } else if (type === 'lowshelf') {
                const sqrt_A = Math.sqrt(A);
                b0 = A * ((A + 1) - (A - 1) * cos_w0 + 2 * sqrt_A * alpha);
                b1 = 2 * A * ((A - 1) - (A + 1) * cos_w0);
                b2 = A * ((A + 1) - (A - 1) * cos_w0 - 2 * sqrt_A * alpha);
                a0 = (A + 1) + (A - 1) * cos_w0 + 2 * sqrt_A * alpha;
                a1 = -2 * ((A - 1) + (A + 1) * cos_w0);
                a2 = (A + 1) + (A - 1) * cos_w0 - 2 * sqrt_A * alpha;
            } else if (type === 'highshelf') {
                const sqrt_A = Math.sqrt(A);
                b0 = A * ((A + 1) + (A - 1) * cos_w0 + 2 * sqrt_A * alpha);
                b1 = -2 * A * ((A - 1) + (A + 1) * cos_w0);
                b2 = A * ((A + 1) + (A - 1) * cos_w0 - 2 * sqrt_A * alpha);
                a0 = (A + 1) - (A - 1) * cos_w0 + 2 * sqrt_A * alpha;
                a1 = 2 * ((A - 1) - (A + 1) * cos_w0);
                a2 = (A + 1) - (A - 1) * cos_w0 - 2 * sqrt_A * alpha;
            }

            // Normalize coefficients
            b0 /= a0;
            b1 /= a0;
            b2 /= a0;
            a1 /= a0;
            a2 /= a0;

            // Calculate magnitude response at frequency Ï‰
            const phi = Math.sin(w/2) * Math.sin(w/2);
            const numerator = (b0 + b1 + b2) * (b0 + b1 + b2) - 4 * (b0 * b1 + 4 * b0 * b2 + b1 * b2) * phi + 16 * b0 * b2 * phi * phi;
            const denominator = (1 + a1 + a2) * (1 + a1 + a2) - 4 * (a1 + 4 * a2 + a1 * a2) * phi + 16 * a2 * phi * phi;

            const magnitude = Math.sqrt(numerator / denominator);
            const gainDb = 20 * Math.log10(magnitude);

            return gainDb;
        }

        function updateMeters(dataArray) {
            // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
            // TRUE K-WEIGHTED LUFS WITH PROPER GATING (ITU-R BS.1770-5 COMPLIANT)
            // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
            if (kWeightedAnalyser) {
                // Get K-weighted time domain data
                const kData = new Float32Array(kWeightedAnalyser.fftSize);
                kWeightedAnalyser.getFloatTimeDomainData(kData);

                // Calculate mean square for current block (400ms equivalent)
                let kMeanSquare = 0;
                for (let i = 0; i < kData.length; i++) {
                    kMeanSquare += kData[i] * kData[i];
                }
                kMeanSquare = kMeanSquare / kData.length;

                // Convert to LUFS using ITU-R BS.1770-5 formula
                const blockLUFS = kMeanSquare > 0 ? -0.691 + 10 * Math.log10(kMeanSquare) : -70;

                // Add to gating buffer
                lufsGatingBuffer.push(blockLUFS);
                if (lufsGatingBuffer.length > 10) { // Keep last ~4 seconds of blocks
                    lufsGatingBuffer.shift();
                }

                // STEP 1: Absolute gate (-70 LUFS) - remove silence
                const absoluteGated = lufsGatingBuffer.filter(lufs => lufs > ABSOLUTE_GATE);

                if (absoluteGated.length > 0) {
                    // STEP 2: Calculate relative gate threshold
                    const meanLUFS = absoluteGated.reduce((a, b) => {
                        const linearA = Math.pow(10, a / 10);
                        const linearB = Math.pow(10, b / 10);
                        return 10 * Math.log10(linearA + linearB);
                    }) / absoluteGated.length;

                    const relativeGateThreshold = meanLUFS + RELATIVE_GATE; // -10 LU below mean

                    // STEP 3: Apply relative gate
                    const relativeGated = absoluteGated.filter(lufs => lufs > relativeGateThreshold);

                    // STEP 4: Calculate final integrated LUFS
                    if (relativeGated.length > 0) {
                        let sumLinear = 0;
                        for (const lufs of relativeGated) {
                            sumLinear += Math.pow(10, lufs / 10);
                        }
                        integratedLUFS = 10 * Math.log10(sumLinear / relativeGated.length);
                    } else {
                        integratedLUFS = blockLUFS; // Fall back to current block
                    }
                } else {
                    integratedLUFS = -70; // Below absolute gate
                }

                // Clamp and update display
                integratedLUFS = Math.max(-70, Math.min(0, integratedLUFS));
                document.getElementById('lufsValue').textContent = integratedLUFS.toFixed(1);
                const lufsPercent = Math.max(0, Math.min(100, ((integratedLUFS + 60) / 60) * 100));
                const lufsMeter = document.getElementById('lufsMeter');
                lufsMeter.style.width = lufsPercent + '%';

                // Dynamic color coding for LUFS (Broadcast standard)
                if (integratedLUFS > -10) {
                    lufsMeter.style.background = 'linear-gradient(90deg, #ff3333, #ff6666)'; // Red (too loud)
                } else if (integratedLUFS >= -16 && integratedLUFS <= -12) {
                    lufsMeter.style.background = 'linear-gradient(90deg, #00ff88, #00ddff)'; // Green (perfect)
                } else if (integratedLUFS > -12) {
                    lufsMeter.style.background = 'linear-gradient(90deg, #ffaa00, #ffcc00)'; // Yellow (loud)
                } else if (integratedLUFS >= -20) {
                    lufsMeter.style.background = 'linear-gradient(90deg, #ffaa00, #ffcc00)'; // Yellow (quiet)
                } else {
                    lufsMeter.style.background = 'linear-gradient(90deg, #4CAF50, #8BC34A)'; // Light green (too quiet)
                }

                // Short-term LUFS (3 seconds, ungated)
                const shortTermBlocks = lufsGatingBuffer.slice(-8); // Last ~3 seconds
                if (shortTermBlocks.length > 0) {
                    let sumLinear = 0;
                    for (const lufs of shortTermBlocks) {
                        sumLinear += Math.pow(10, lufs / 10);
                    }
                    shortTermLUFS = 10 * Math.log10(sumLinear / shortTermBlocks.length);
                } else {
                    shortTermLUFS = integratedLUFS;
                }

                // Momentary LUFS (400ms, current block)
                momentaryLUFS = blockLUFS;

                document.getElementById('shortLufsValue').textContent = shortTermLUFS.toFixed(1);
                document.getElementById('momentaryLufsValue').textContent = momentaryLUFS.toFixed(1);
            }

            // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
            // TRUE PEAK DETECTION WITH 4X OVERSAMPLING (Prevents codec overshoot)
            // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
            if (leftAnalyser && rightAnalyser) {
                const leftData = new Float32Array(leftAnalyser.fftSize);
                const rightData = new Float32Array(rightAnalyser.fftSize);
                leftAnalyser.getFloatTimeDomainData(leftData);
                rightAnalyser.getFloatTimeDomainData(rightData);

                // 4x oversampling using linear interpolation
                const oversampleFactor = 4;
                let truePeakL = 0;
                let truePeakR = 0;

                for (let i = 0; i < leftData.length - 1; i++) {
                    for (let j = 0; j < oversampleFactor; j++) {
                        const t = j / oversampleFactor;
                        // Linear interpolation between samples
                        const interpL = leftData[i] * (1 - t) + leftData[i + 1] * t;
                        const interpR = rightData[i] * (1 - t) + rightData[i + 1] * t;
                        truePeakL = Math.max(truePeakL, Math.abs(interpL));
                        truePeakR = Math.max(truePeakR, Math.abs(interpR));
                    }
                }

                // Convert to dBTP (true peak)
                const truePeak = Math.max(truePeakL, truePeakR);
                const peakDb = truePeak > 0 ? 20 * Math.log10(truePeak) : -70;
                truePeakMax = Math.max(truePeakMax, peakDb);

                document.getElementById('peakValue').textContent = peakDb.toFixed(1);
                const peakPercent = Math.max(0, Math.min(100, ((peakDb + 60) / 60) * 100));
                const peakMeter = document.getElementById('peakMeter');
                peakMeter.style.width = peakPercent + '%';

                // Dynamic color coding for peak meter (Broadcast standard)
                if (peakDb > -1.0) {
                    peakMeter.style.background = 'linear-gradient(90deg, #ff3333, #ff6666)'; // Red (danger)
                } else if (peakDb > -3.0) {
                    peakMeter.style.background = 'linear-gradient(90deg, #ffaa00, #ffcc00)'; // Yellow (caution)
                } else if (peakDb > -6.0) {
                    peakMeter.style.background = 'linear-gradient(90deg, #00ff88, #00ddff)'; // Green (good)
                } else {
                    peakMeter.style.background = 'linear-gradient(90deg, #2196F3, #03A9F4)'; // Blue (safe)
                }

                // Peak warning
                const peakWarning = document.getElementById('peakWarning');
                if (peakDb > -1) {
                    peakWarning.style.color = '#ff4444';
                    peakWarning.textContent = 'âš ï¸ EXCEEDS -1.0 dBTP LIMIT!';
                } else {
                    peakWarning.style.color = 'rgba(255, 255, 255, 0.5)';
                    peakWarning.textContent = 'Max: -1.0 dBTP (Streaming)';
                }

                // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
                // REAL PHASE CORRELATION (Not simulated - actual L/R correlation)
                // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
                let lrSum = 0;
                let lSquared = 0;
                let rSquared = 0;
                for (let i = 0; i < leftData.length; i++) {
                    lrSum += leftData[i] * rightData[i];
                    lSquared += leftData[i] * leftData[i];
                    rSquared += rightData[i] * rightData[i];
                }
                const phaseCorrelation = (lSquared * rSquared > 0) ?
                    lrSum / Math.sqrt(lSquared * rSquared) : 0;

                document.getElementById('phaseValue').textContent = phaseCorrelation.toFixed(2);
                const phasePercent = (phaseCorrelation + 1) / 2 * 100;
                const phaseMeter = document.getElementById('phaseMeter');
                phaseMeter.style.width = phasePercent + '%';

                // Dynamic color coding for phase correlation
                if (phaseCorrelation < 0) {
                    phaseMeter.style.background = 'linear-gradient(90deg, #ff3333, #ff6666)'; // Red (phase issues)
                } else if (phaseCorrelation < 0.5) {
                    phaseMeter.style.background = 'linear-gradient(90deg, #ffaa00, #ffcc00)'; // Yellow (narrow)
                } else if (phaseCorrelation >= 0.7) {
                    phaseMeter.style.background = 'linear-gradient(90deg, #00ff88, #00ddff)'; // Green (good stereo)
                } else {
                    phaseMeter.style.background = 'linear-gradient(90deg, #9C27B0, #E91E63)'; // Purple (moderate)
                }
            }

            // Loudness Range (LRA)
            lraMin = Math.min(lraMin, integratedLUFS);
            lraMax = Math.max(lraMax, integratedLUFS);
            lra = lraMax - lraMin; // Update global lra variable
            document.getElementById('lraValue').textContent = lra.toFixed(1) + ' LU';

            // Crest Factor
            const crestFactor = peakDb - integratedLUFS;
            document.getElementById('crestValue').textContent = crestFactor.toFixed(1) + ' dB';

            // PLR (Peak to Loudness Ratio)
            const plr = truePeakMax - integratedLUFS;
            document.getElementById('plrValue').textContent = plr.toFixed(1) + ' dB';

            // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
            // PROFESSIONAL QUALITY SCORE - Positive Scoring System (Steely Dan Grade)
            // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
            let qualityScore = 0;

            // 1. LUFS Targeting (25 points) - Streaming-ready loudness
            // Reward proper streaming loudness (-16 to -12 LUFS)
            if (integratedLUFS >= -16 && integratedLUFS <= -12) {
                qualityScore += 25; // Perfect streaming loudness
            } else if (integratedLUFS >= -18 && integratedLUFS < -16) {
                qualityScore += 20; // Slightly quiet but safe
            } else if (integratedLUFS > -12 && integratedLUFS <= -10) {
                qualityScore += 20; // Slightly loud but acceptable
            } else if (integratedLUFS >= -20 && integratedLUFS < -18) {
                qualityScore += 15; // Too quiet
            } else if (integratedLUFS > -10 && integratedLUFS <= -8) {
                qualityScore += 15; // Too loud
            } else if (integratedLUFS >= -23 && integratedLUFS < -20) {
                qualityScore += 10; // Way too quiet
            } else if (integratedLUFS > -8) {
                qualityScore += 5; // Dangerously loud
            }

            // 2. True Peak Control (25 points) - Prevent clipping on codecs
            // Reward proper headroom for codec processing
            if (truePeakMax <= -1.0 && truePeakMax >= -3.0) {
                qualityScore += 25; // Perfect headroom (Steely Dan standard)
            } else if (truePeakMax <= -0.5 && truePeakMax > -1.0) {
                qualityScore += 20; // Good headroom
            } else if (truePeakMax < -3.0 && truePeakMax >= -6.0) {
                qualityScore += 20; // Conservative (safe)
            } else if (truePeakMax <= -0.1 && truePeakMax > -0.5) {
                qualityScore += 15; // Minimal headroom
            } else if (truePeakMax < -6.0) {
                qualityScore += 15; // Too much headroom (losing loudness)
            } else if (truePeakMax > -0.1) {
                qualityScore += 5; // Risk of clipping
            }

            // 3. Dynamic Range / LRA (20 points) - Musical dynamics
            // Reward natural dynamic range (not over-compressed)
            if (lra >= 6 && lra <= 12) {
                qualityScore += 20; // Perfect dynamic range (Steely Dan sweet spot)
            } else if (lra >= 5 && lra < 6) {
                qualityScore += 17; // Slightly compressed
            } else if (lra > 12 && lra <= 15) {
                qualityScore += 17; // Slightly dynamic
            } else if (lra >= 4 && lra < 5) {
                qualityScore += 14; // Compressed
            } else if (lra > 15 && lra <= 20) {
                qualityScore += 14; // Very dynamic
            } else if (lra >= 3 && lra < 4) {
                qualityScore += 10; // Heavily compressed
            } else if (lra > 20) {
                qualityScore += 10; // Extremely dynamic (may need compression)
            } else if (lra < 3) {
                qualityScore += 5; // Brick-walled (no dynamics left)
            }

            // 4. Crest Factor (20 points) - Transient preservation
            // Reward preserved transients and punch
            if (crestFactor >= 10 && crestFactor <= 16) {
                qualityScore += 20; // Perfect transient preservation
            } else if (crestFactor >= 9 && crestFactor < 10) {
                qualityScore += 17; // Good transients
            } else if (crestFactor > 16 && crestFactor <= 18) {
                qualityScore += 17; // Excellent transients
            } else if (crestFactor >= 8 && crestFactor < 9) {
                qualityScore += 14; // Acceptable transients
            } else if (crestFactor > 18 && crestFactor <= 20) {
                qualityScore += 14; // Very punchy
            } else if (crestFactor >= 6 && crestFactor < 8) {
                qualityScore += 10; // Squashed
            } else if (crestFactor > 20) {
                qualityScore += 10; // May need limiting
            } else if (crestFactor < 6) {
                qualityScore += 5; // Severely squashed
            }

            // 5. Phase Correlation Bonus (10 points) - Stereo health
            // Reward good stereo imaging
            if (phaseCorrelation >= 0.5 && phaseCorrelation <= 1.0) {
                qualityScore += 10; // Excellent stereo image
            } else if (phaseCorrelation >= 0.3 && phaseCorrelation < 0.5) {
                qualityScore += 7; // Good stereo width
            } else if (phaseCorrelation >= 0.1 && phaseCorrelation < 0.3) {
                qualityScore += 5; // Wide stereo
            } else if (phaseCorrelation < 0.1) {
                qualityScore += 2; // Phase issues possible
            }

            // Ensure score stays within 0-100 range
            qualityScore = Math.max(0, Math.min(100, qualityScore));

            document.getElementById('qualityValue').textContent = qualityScore + '/100';
            const qualityEl = document.getElementById('qualityValue');
            if (qualityScore >= 90) {
                qualityEl.style.color = '#43e97b';
            } else if (qualityScore >= 70) {
                qualityEl.style.color = '#fee140';
            } else {
                qualityEl.style.color = '#fa709a';
            }
        }

        // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        // EQ COMPENSATION - Automatic gain reduction when EQ is boosted
        // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        function updateEQCompensation() {
            if (!eqCompensationGain || !eqSubFilter || !eqBassFilter) return;

            // Calculate total EQ boost across all bands
            const eqGains = [
                eqSubFilter.gain.value,
                eqBassFilter.gain.value,
                eqLowMidFilter.gain.value,
                eqMidFilter.gain.value,
                eqHighMidFilter.gain.value,
                eqHighFilter.gain.value,
                eqAirFilter.gain.value
            ];

            // Sum all positive gains (boosts only)
            let totalBoost = 0;
            eqGains.forEach(gain => {
                if (gain > 0) totalBoost += gain;
            });

            // Calculate compensation (reduce by total boost amount)
            // Use a safety factor of 0.7 to be conservative
            const compensationDB = -totalBoost * 0.7;
            const compensationLinear = Math.pow(10, compensationDB / 20);

            // Apply compensation (never boost, only reduce)
            eqCompensationGain.gain.value = Math.min(1.0, compensationLinear);

            // Log compensation if significant
            if (Math.abs(compensationDB) > 0.5) {
                console.log(`ğŸšï¸ EQ Compensation: ${compensationDB.toFixed(1)} dB (preventing distortion)`);
            }
        }

        // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        // 5-PHASE AI AUTO MASTER SYSTEM - LEGENDARY EDITION
        // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        document.getElementById('autoMasterBtn').addEventListener('click', async () => {
            // âœ¨ ENHANCED: Use legendary AI Auto Master with auto-fix
            if (typeof runEnhancedAIAutoMaster === 'function') {
                await runEnhancedAIAutoMaster();
                return;
            }

            // Fallback to original if enhanced version not available
            if (!uploadedFile || !analyser) {
                console.error('âŒ Cannot run Auto Master: No file uploaded or analyser not initialized');
                return;
            }

            console.log('ğŸ¤– 5-PHASE AI AUTO MASTER - Starting...');

            try {
                progressOverlay.style.display = 'flex';
                progressText.textContent = 'âš™ï¸ DSP Engine - Phase 1/5';
                progressDetail.textContent = 'ITU-R BS.1770-5 LUFS measurement & spectral analysis...';

                await new Promise(resolve => setTimeout(resolve, 800));

                // PHASE 1: Spectral Analysis & LUFS Measurement
                console.log('â”â”â” PHASE 1: Spectral Analysis & LUFS Measurement (ITU-R BS.1770-5) â”â”â”');
                    // PROFESSIONAL: Use 32-bit float precision for analysis
                    const dataArray = new Float32Array(analyser.frequencyBinCount);
                    analyser.getFloatFrequencyData(dataArray);

                    function getFreqRMS(lowFreq, highFreq) {
                        const nyquist = audioContext.sampleRate / 2;
                        const binResolution = nyquist / analyser.frequencyBinCount;
                        const lowBin = Math.floor(lowFreq / binResolution);
                        const highBin = Math.ceil(highFreq / binResolution);

                        let sum = 0;
                        let count = 0;
                        for (let i = lowBin; i <= highBin && i < dataArray.length; i++) {
                            // Convert dB to linear for RMS calculation
                            const dbValue = dataArray[i];
                            const linearValue = Math.pow(10, dbValue / 20);
                            sum += linearValue;
                            count++;
                        }
                        return count > 0 ? sum / count : 0;
                    }
    
                    const subBassRMS = getFreqRMS(20, 60);
                    const bassRMS = getFreqRMS(60, 250);
                    const lowMidRMS = getFreqRMS(250, 500);
                    const midRMS = getFreqRMS(500, 2000);
                    const highMidRMS = getFreqRMS(2000, 6000);
                    const highRMS = getFreqRMS(6000, 12000);
                    const airRMS = getFreqRMS(12000, 20000);
                    const avgEnergy = (subBassRMS + bassRMS + lowMidRMS + midRMS + highMidRMS + highRMS + airRMS) / 7;
    
                    console.log('ğŸ“Š Current LUFS:', integratedLUFS.toFixed(1));
                    console.log('ğŸ“Š Frequency Analysis:', { subBassRMS, bassRMS, lowMidRMS, midRMS, highMidRMS, highRMS, airRMS, avgEnergy });
    
                    // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
                    // PHASE 2: PSYCHOACOUSTIC SPECTRAL TILT ANALYSIS
                    // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
                    progressText.textContent = 'âš™ï¸ DSP Engine - Phase 2/5';
                    progressDetail.textContent = 'Psychoacoustic spectral tilt analysis (Fletcher-Munson)...';
                    await new Promise(resolve => setTimeout(resolve, 800));

                    console.log('â”â”â” PHASE 2: Psychoacoustic Spectral Tilt Analysis (Fletcher-Munson) â”â”â”');
    
                    // Analyze spectral tilt (Steely Dan has slight warm tilt with extended highs)
                    const lowEnergy = (subBassRMS + bassRMS + lowMidRMS) / 3;
                    const midEnergy = (midRMS + highMidRMS) / 2;
                    const highEnergy = (highRMS + airRMS) / 2;
    
                    const spectralTilt = (lowEnergy - highEnergy) / (lowEnergy + highEnergy + 0.01);
                    console.log('ğŸ“Š Spectral Tilt:', spectralTilt.toFixed(3), '(Steely Dan target: 0.05 to 0.15)');
    
                    // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
                    // PHASE 3: ADAPTIVE GAIN NORMALIZATION (K-System Metering)
                    // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
                    progressText.textContent = 'âš™ï¸ DSP Engine - Phase 3/5';
                    progressDetail.textContent = 'Transient-preserving gain normalization (K-System)...';
                    await new Promise(resolve => setTimeout(resolve, 800));

                    console.log('â”â”â” PHASE 3: Adaptive Gain Normalization (K-System Metering) â”â”â”');
                    const targetLUFS = -14; // Streaming-optimal
                    const lufsGainNeeded = targetLUFS - integratedLUFS;
    
                    // Preserve transients: limit gain boost if peak is already high
                    let safeGain = lufsGainNeeded;
                    if (truePeakMax > -6 && lufsGainNeeded > 0) {
                        // Already has good peaks, be conservative with gain
                        safeGain = Math.min(lufsGainNeeded, 6);
                        console.log('âš ï¸ High peaks detected, limiting gain boost to preserve transients');
                    }
                    safeGain = Math.max(-6, Math.min(12, safeGain));
                    console.log('ğŸ“Š Gain adjustment:', safeGain.toFixed(1), 'dB (transient-aware)');
    
                    // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
                    // PHASE 4: PARAMETRIC EQ OPTIMIZATION (7-Band Surgical Processing)
                    // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
                    progressText.textContent = 'âš™ï¸ DSP Engine - Phase 4/5';
                    progressDetail.textContent = 'Parametric EQ optimization (SSL E-Series algorithm)...';
                    await new Promise(resolve => setTimeout(resolve, 800));

                    console.log('â”â”â” PHASE 4: Parametric EQ Optimization (7-Band Surgical Processing) â”â”â”');
    
                    // STEELY DAN EQ PHILOSOPHY:
                    // 1. Tight, controlled low end (not boomy)
                    // 2. Cut mud aggressively (300-500Hz)
                    // 3. Enhance vocal presence (2-3kHz)
                    // 4. Smooth, extended highs (8-12kHz air)
                    // 5. Gentle rolloff above 16kHz
    
                    // Sub Bass (40Hz) - Tight and controlled
                    let suggestedSub = 0;
                    if (subBassRMS < avgEnergy * 0.6) {
                        suggestedSub = Math.min(4, ((avgEnergy * 0.7 - subBassRMS) / 50) * 8);
                        console.log('ğŸšï¸ Sub: Gentle boost for foundation');
                    } else if (subBassRMS > avgEnergy * 1.2) {
                        suggestedSub = Math.max(-6, -((subBassRMS - avgEnergy) / 50) * 8);
                        console.log('ğŸšï¸ Sub: Cut excessive rumble (Steely Dan precision)');
                    }
    
                    // Bass (120Hz) - Punchy and tight, cut mud
                    let suggestedBass = 0;
                    if (bassRMS < avgEnergy * 0.8) {
                        suggestedBass = Math.min(6, ((avgEnergy * 0.9 - bassRMS) / 50) * 10);
                        console.log('ğŸšï¸ Bass: Boost for punch and warmth');
                    } else if (bassRMS > avgEnergy * 1.3) {
                        suggestedBass = Math.max(-5, -((bassRMS - avgEnergy) / 50) * 8);
                        console.log('ğŸšï¸ Bass: Tighten excessive low end');
                    }
    
                    // Low Mids (350Hz) - CUT MUD AGGRESSIVELY (Steely Dan signature)
                    let suggestedLowMid = Math.max(-8, Math.min(2, ((avgEnergy * 0.7 - lowMidRMS) / 50) * 10));
                    if (lowMidRMS > avgEnergy * 1.1) {
                        suggestedLowMid = Math.max(-8, -((lowMidRMS - avgEnergy) / 40) * 12);
                        console.log('ğŸšï¸ Low Mid: CUTTING MUD aggressively (Steely Dan clarity)');
                    }
    
                    // Mids (1kHz) - Natural and clear
                    let suggestedMid = Math.max(-5, Math.min(8, ((avgEnergy - midRMS) / 50) * 10));
                    if (midRMS < avgEnergy * 0.85) {
                        suggestedMid = Math.min(6, ((avgEnergy - midRMS) / 50) * 12);
                        console.log('ğŸšï¸ Mid: Enhance body and warmth');
                    }
    
                    // High Mids (3.5kHz) - VOCAL PRESENCE (Steely Dan vocal clarity)
                    let suggestedHighMid = Math.max(-4, Math.min(8, ((avgEnergy * 1.1 - highMidRMS) / 50) * 12));
                    if (highMidRMS < avgEnergy * 0.9) {
                        suggestedHighMid = Math.min(8, ((avgEnergy * 1.15 - highMidRMS) / 45) * 14);
                        console.log('ğŸšï¸ High Mid: BOOST PRESENCE for vocal clarity (Steely Dan signature)');
                    } else if (highMidRMS > avgEnergy * 1.4) {
                        suggestedHighMid = Math.max(-4, -((highMidRMS - avgEnergy) / 50) * 8);
                        console.log('ğŸšï¸ High Mid: Tame harshness');
                    }
    
                    // Highs (8kHz) - Smooth and extended
                    let suggestedHigh = Math.max(-3, Math.min(7, ((avgEnergy * 0.95 - highRMS) / 50) * 10));
                    if (highRMS < avgEnergy * 0.75) {
                        suggestedHigh = Math.min(7, ((avgEnergy * 0.9 - highRMS) / 48) * 12);
                        console.log('ğŸšï¸ High: Smooth high-end extension');
                    } else if (highRMS > avgEnergy * 1.3) {
                        suggestedHigh = Math.max(-3, -((highRMS - avgEnergy) / 50) * 6);
                        console.log('ğŸšï¸ High: Prevent harshness');
                    }
    
                    // Air (14kHz) - Steely Dan SIGNATURE smooth air
                    let suggestedAir = Math.max(-2, Math.min(6, ((avgEnergy * 0.8 - airRMS) / 50) * 10));
                    if (airRMS < avgEnergy * 0.65) {
                        suggestedAir = Math.min(6, ((avgEnergy * 0.75 - airRMS) / 50) * 11);
                        console.log('ğŸšï¸ Air: Add Steely Dan signature smooth air and sparkle');
                    } else if (airRMS > avgEnergy * 1.1) {
                        suggestedAir = Math.max(-2, -((airRMS - avgEnergy) / 50) * 5);
                        console.log('ğŸšï¸ Air: Gentle rolloff (natural and smooth)');
                    }
    
                    // Apply spectral tilt correction for Steely Dan warmth
                    if (spectralTilt < 0.05) {
                        console.log('ğŸšï¸ Applying Steely Dan warm tilt correction...');
                        suggestedSub += 1.5;
                        suggestedBass += 2.0;
                        suggestedLowMid += 0.5;
                        suggestedAir -= 0.5;
                    } else if (spectralTilt > 0.25) {
                        console.log('ğŸšï¸ Too warm, brightening for clarity...');
                        suggestedHighMid += 2.0;
                        suggestedHigh += 1.5;
                        suggestedAir += 1.0;
                    }
    
                    // Clamp all values to Â±12dB range (our new powerful range)
                    suggestedSub = Math.max(-12, Math.min(12, suggestedSub));
                    suggestedBass = Math.max(-12, Math.min(12, suggestedBass));
                    suggestedLowMid = Math.max(-12, Math.min(12, suggestedLowMid));
                    suggestedMid = Math.max(-12, Math.min(12, suggestedMid));
                    suggestedHighMid = Math.max(-12, Math.min(12, suggestedHighMid));
                    suggestedHigh = Math.max(-12, Math.min(12, suggestedHigh));
                    suggestedAir = Math.max(-12, Math.min(12, suggestedAir));
    
                    console.log('ğŸ“Š Steely Dan EQ:', {
                        sub: suggestedSub.toFixed(1),
                        bass: suggestedBass.toFixed(1),
                        lowMid: suggestedLowMid.toFixed(1),
                        mid: suggestedMid.toFixed(1),
                        highMid: suggestedHighMid.toFixed(1),
                        high: suggestedHigh.toFixed(1),
                        air: suggestedAir.toFixed(1)
                    });
    
                    // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
                    // PHASE 5: ADAPTIVE DYNAMICS PROCESSING (Multi-Stage Compression)
                    // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
                    progressText.textContent = 'âš™ï¸ DSP Engine - Phase 5/5';
                    progressDetail.textContent = 'Dynamic range compression (VCA/FET emulation)...';
                    await new Promise(resolve => setTimeout(resolve, 800));

                    console.log('â”â”â” PHASE 5: Adaptive Dynamics Processing (Multi-Stage Compression) â”â”â”');
                    let detectedGenre = 'Balanced';
                    let suggestedCompression = 3; // Start conservative (Steely Dan = transparent)
    
                    // Analyze dynamic range to determine compression need
                    if (lra > 15) {
                        suggestedCompression = 5; // More dynamic content needs gentle compression
                        detectedGenre = 'Dynamic/Classical';
                        console.log('ğŸ“Š High dynamic range detected - gentle compression for control');
                    } else if (lra < 6) {
                        suggestedCompression = 2; // Already compressed, stay light
                        detectedGenre = 'Modern/Compressed';
                        console.log('ğŸ“Š Already compressed - minimal additional compression');
                    } else if (bassRMS > avgEnergy * 1.3 && subBassRMS > avgEnergy) {
                        detectedGenre = 'EDM/Hip-Hop';
                        suggestedCompression = 6; // More compression for consistent bass
                        console.log('ğŸ“Š Bass-heavy genre - controlled compression for punch');
                    } else if (midRMS > avgEnergy * 1.2 && highMidRMS > avgEnergy) {
                        detectedGenre = 'Vocal/Acoustic';
                        suggestedCompression = 4; // Gentle compression for vocals
                        console.log('ğŸ“Š Vocal-focused - transparent compression for presence');
                    } else if (highRMS > avgEnergy && airRMS > avgEnergy * 0.8) {
                        detectedGenre = 'Rock/Pop';
                        suggestedCompression = 5; // Moderate compression for energy
                        console.log('ğŸ“Š Rock/Pop energy - balanced compression');
                    } else {
                        suggestedCompression = 4; // Balanced content
                        detectedGenre = 'Balanced/Universal';
                        console.log('ğŸ“Š Balanced content - moderate transparent compression');
                    }
    
                    console.log('ğŸ“Š Detected Genre:', detectedGenre, '- Compression:', suggestedCompression + ':1 (Steely Dan transparent)');
    
                    // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
                    // APPLY BROADCAST-GRADE MASTERING CHAIN
                    // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
                    progressText.textContent = 'âœ… Applying Master';
                    progressDetail.textContent = 'Broadcast-grade mastering chain activation...';
                    await new Promise(resolve => setTimeout(resolve, 800));

                    console.log('â”â”â” APPLYING BROADCAST-GRADE MASTERING CHAIN â”â”â”');
    
                    // Apply gain
                    if (masterGain) {
                        const linearGain = Math.pow(10, safeGain / 20);
                        masterGain.gain.value = linearGain;
                        document.getElementById('masterGainValue').textContent = (safeGain >= 0 ? '+' : '') + safeGain.toFixed(1) + ' dB';
                        document.getElementById('masterGainSlider').value = safeGain;
                    }
    
                    // Apply EQ
                    if (eqSubFilter) eqSubFilter.gain.value = suggestedSub;
                    if (eqBassFilter) eqBassFilter.gain.value = suggestedBass;
                    if (eqLowMidFilter) eqLowMidFilter.gain.value = suggestedLowMid;
                    if (eqMidFilter) eqMidFilter.gain.value = suggestedMid;
                    if (eqHighMidFilter) eqHighMidFilter.gain.value = suggestedHighMid;
                    if (eqHighFilter) eqHighFilter.gain.value = suggestedHigh;
                    if (eqAirFilter) eqAirFilter.gain.value = suggestedAir;
    
                    // Apply automatic EQ compensation to prevent distortion
                    updateEQCompensation();
    
                    // Update UI
                    document.getElementById('eqSubValue').textContent = (suggestedSub >= 0 ? '+' : '') + suggestedSub.toFixed(1) + ' dB';
                    document.getElementById('eqBassValue').textContent = (suggestedBass >= 0 ? '+' : '') + suggestedBass.toFixed(1) + ' dB';
                    document.getElementById('eqLowMidValue').textContent = (suggestedLowMid >= 0 ? '+' : '') + suggestedLowMid.toFixed(1) + ' dB';
                    document.getElementById('eqMidValue').textContent = (suggestedMid >= 0 ? '+' : '') + suggestedMid.toFixed(1) + ' dB';
                    document.getElementById('eqHighMidValue').textContent = (suggestedHighMid >= 0 ? '+' : '') + suggestedHighMid.toFixed(1) + ' dB';
                    document.getElementById('eqHighValue').textContent = (suggestedHigh >= 0 ? '+' : '') + suggestedHigh.toFixed(1) + ' dB';
                    document.getElementById('eqAirValue').textContent = (suggestedAir >= 0 ? '+' : '') + suggestedAir.toFixed(1) + ' dB';
    
                    // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
                    // ADAPTIVE DYNAMICS PROCESSING (Based on LRA & Genre)
                    // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
                    if (compressor && limiter) {
                        // Adaptive compressor threshold based on current LUFS
                        let adaptiveThreshold = -24;
                        if (integratedLUFS < -20) {
                            adaptiveThreshold = -30; // Quieter content, lower threshold
                        } else if (integratedLUFS > -12) {
                            adaptiveThreshold = -18; // Louder content, higher threshold
                        }

                        // Adaptive ratio based on LRA (dynamic range)
                        const ratio = 1 + (suggestedCompression / 10) * 19;

                        // Adaptive attack/release based on genre
                        let attack = 0.003; // Default 3ms
                        let release = 0.25; // Default 250ms

                        if (detectedGenre.includes('Classical') || detectedGenre.includes('Dynamic')) {
                            attack = 0.010; // Slower attack for transient preservation (10ms)
                            release = 0.40; // Longer release for natural decay (400ms)
                        } else if (detectedGenre.includes('EDM') || detectedGenre.includes('Hip-Hop')) {
                            attack = 0.001; // Fast attack for punch control (1ms)
                            release = 0.15; // Faster release for energy (150ms)
                        } else if (detectedGenre.includes('Rock') || detectedGenre.includes('Pop')) {
                            attack = 0.003; // Balanced attack (3ms)
                            release = 0.20; // Balanced release (200ms)
                        }

                        compressor.threshold.value = adaptiveThreshold;
                        compressor.ratio.value = ratio;
                        compressor.attack.value = attack;
                        compressor.release.value = release;

                        // Adaptive limiter ceiling based on target platform
                        let limiterCeiling = -1.5; // Default streaming
                        if (integratedLUFS < -16) {
                            limiterCeiling = -2.0; // More headroom for quieter content
                        } else if (integratedLUFS > -12) {
                            limiterCeiling = -1.0; // Less headroom for louder content
                        }

                        limiter.threshold.value = limiterCeiling;

                        console.log('ğŸ›ï¸ Adaptive Dynamics Applied:');
                        console.log('   Compressor: threshold=' + adaptiveThreshold + 'dB, ratio=' + ratio.toFixed(1) + ':1, attack=' + (attack*1000).toFixed(1) + 'ms, release=' + (release*1000).toFixed(0) + 'ms');
                        console.log('   Limiter: ceiling=' + limiterCeiling + 'dBTP');

                        document.getElementById('compValue').textContent = Math.round(suggestedCompression * 10) + '%';
                        document.getElementById('compSlider').value = Math.round(suggestedCompression * 10);
                        document.getElementById('limiterValue').textContent = limiterCeiling.toFixed(1) + ' dB';
                        document.getElementById('limiterSlider').value = limiterCeiling;
                    }
    
                console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
                console.log('âœ… STEELY DAN MASTERING COMPLETE!');
                console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
                console.log('   ğŸµ Genre:', detectedGenre);
                console.log('   ğŸ“Š Gain:', safeGain.toFixed(1), 'dB (transient-aware)');
                console.log('   ğŸšï¸ EQ: Sub', suggestedSub.toFixed(1), '| Bass', suggestedBass.toFixed(1), '| LowMid', suggestedLowMid.toFixed(1), '| Mid', suggestedMid.toFixed(1), '| HighMid', suggestedHighMid.toFixed(1), '| High', suggestedHigh.toFixed(1), '| Air', suggestedAir.toFixed(1));
                console.log('   ğŸ›ï¸ Compression:', suggestedCompression + ':1 (musical & transparent)');
                console.log('   ğŸ¯ Target: -14 LUFS | Headroom: -1.0 dBTP | Steely Dan quality');
                console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');

            } catch (error) {
                console.error('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
                console.error('âŒ AUTO MASTER ERROR:');
                console.error('Error message:', error.message);
                console.error('Error stack:', error.stack);
                console.error('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
                console.error('Debug info:', {
                    uploadedFile: !!uploadedFile,
                    analyser: !!analyser,
                    integratedLUFS: integratedLUFS,
                    truePeakMax: truePeakMax,
                    lra: lra
                });
                alert('Auto Master encountered an error. Please check the browser console (F12) for details.\n\nError: ' + error.message);
            } finally {
                // ALWAYS hide progress overlay, even if there was an error
                progressOverlay.style.display = 'none';
                console.log('ğŸ”„ Progress overlay hidden');
            }
        });

        // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        // RESET BUTTON
        // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        document.getElementById('resetBtn').addEventListener('click', () => {
            // Reset all EQ filters to 0 dB
            if (eqSubFilter) eqSubFilter.gain.value = 0;
            if (eqBassFilter) eqBassFilter.gain.value = 0;
            if (eqLowMidFilter) eqLowMidFilter.gain.value = 0;
            if (eqMidFilter) eqMidFilter.gain.value = 0;
            if (eqHighMidFilter) eqHighMidFilter.gain.value = 0;
            if (eqHighFilter) eqHighFilter.gain.value = 0;
            if (eqAirFilter) eqAirFilter.gain.value = 0;

            // Reset compressor
            if (compressor) {
                compressor.ratio.value = 1;
                compressor.threshold.value = -24;
            }

            // Reset master gain
            if (masterGain) {
                masterGain.gain.value = 1;
            }

            // Reset EQ compensation
            if (eqCompensationGain) {
                eqCompensationGain.gain.value = 1.0;
            }

            // Reset UI
            Object.keys(eqFaders).forEach(band => {
                const thumb = document.querySelector(`.eq-fader-thumb[data-eq="${band}"]`);
                thumb.style.top = '50%';
                eqFaders[band].valueEl.textContent = '0.0 dB';
            });

            document.getElementById('compSlider').value = 0;
            document.getElementById('compValue').textContent = '0%';
            document.getElementById('widthSlider').value = 100;
            document.getElementById('widthValue').textContent = '100%';
            document.getElementById('limiterSlider').value = -1.5;
            document.getElementById('limiterValue').textContent = '-1.5 dB';
            document.getElementById('outputGainSlider').value = 0;
            document.getElementById('outputGainValue').textContent = '0.0 dB';
            document.getElementById('masterGainSlider').value = 0;
            document.getElementById('masterGainValue').textContent = '0.0 dB';

            console.log('ğŸ”„ All settings reset to default');
        });

        // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        // A/B COMPARE BUTTON - Toggle between processed and original
        // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        document.getElementById('abCompareBtn').addEventListener('click', function() {
            if (!sourceNode) return;

            abCompareMode = !abCompareMode;
            const btn = this;

            if (abCompareMode) {
                // Mode B: BYPASS - hear original (no processing)
                try {
                    // Disconnect entire processing chain
                    sourceNode.disconnect();
                    // Connect directly to master gain (bypass all EQ/dynamics)
                    sourceNode.connect(masterGain);

                    btn.textContent = 'ğŸ”€ LISTENING: ORIGINAL (B)';
                    btn.style.background = 'linear-gradient(135deg, #43e97b, #38f9d7)';
                    console.log('ğŸ”€ A/B Compare: Mode B - ORIGINAL (all processing bypassed)');
                } catch (e) {
                    console.warn('A/B disconnect warning:', e);
                }
            } else {
                // Mode A: PROCESSED - hear with all processing
                try {
                    // Reconnect full processing chain
                    sourceNode.disconnect();
                    if (!eqBypassed) {
                        // Full EQ chain
                        sourceNode.connect(eqSubFilter);
                        eqSubFilter.connect(eqBassFilter);
                        eqBassFilter.connect(eqLowMidFilter);
                        eqLowMidFilter.connect(eqMidFilter);
                        eqMidFilter.connect(eqHighMidFilter);
                        eqHighMidFilter.connect(eqHighFilter);
                        eqHighFilter.connect(eqAirFilter);
                        eqAirFilter.connect(eqCompensationGain);
                        eqCompensationGain.connect(compressor);
                    } else {
                        // EQ bypassed, connect to compressor
                        sourceNode.connect(compressor);
                    }
                    compressor.connect(limiter);
                    limiter.connect(masterGain);

                    btn.textContent = 'ğŸ”€ LISTENING: MASTERED (A)';
                    btn.style.background = 'linear-gradient(135deg, #ff9a56, #ff5733)';
                    console.log('ğŸ”€ A/B Compare: Mode A - MASTERED (full processing active)');
                } catch (e) {
                    console.warn('A/B connect warning:', e);
                }
            }
        });

        // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        // SELECTOR BUTTONS
        // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        document.querySelectorAll('.selector-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                this.parentElement.querySelectorAll('.selector-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
            });
        });

        document.querySelectorAll('.export-format-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.export-format-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
            });
        });

        // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        // EXPORT BUTTON
        // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        document.getElementById('exportBtn').addEventListener('click', () => {
            alert('Export functionality coming soon!\n\nThis will render your mastered audio with all EQ, compression, and effects applied.');
        });

        // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        // INITIALIZATION
        // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        window.addEventListener('load', () => {
            console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
            console.log('ğŸšï¸ LuvLang ULTIMATE - Steely Dan Mastering Quality');
            console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
            console.log('   ğŸ›ï¸  Professional 3-column SSL/Neve console interface');
            console.log('   ğŸšï¸  7-band parametric EQ (Â±12dB range, Q=0.7, FabFilter quality)');
            console.log('   ğŸ“Š  Professional EQ Graph with 32K FFT spectrum analyzer');
            console.log('   ğŸ“¡  9 broadcast-grade meters (ITU-R BS.1770-5 LUFS, True Peak, Phase)');
            console.log('   ğŸ¤–  5-phase AI Auto Master (Steely Dan surgical precision)');
            console.log('   âœ¨  Advanced Quality Score (0-100, rewards mastering excellence)');
            console.log('   ğŸ”Š  Musical compression & transparent limiting (-1.5 dBTP)');
            console.log('   âš¡  Real-time Web Audio processing at 48kHz');
            console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
            console.log('   Ready for professional mastering. Upload audio to begin.');
            console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
        });

    </script>

    <!-- â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
         LUVLANG LEGENDARY FEATURES - INTEGRATED MODULES
         â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” -->
    <script src="reference-track-matching.js"></script>
    <script src="multiband-compression.js"></script>
    <script src="ms-processing.js"></script>
    <script src="preset-manager.js"></script>
    <script src="keyboard-shortcuts.js"></script>
    <script src="undo-redo-manager.js"></script>
    <script src="CRITICAL_FIXES.js"></script>
    <script src="INTEGRATION_SCRIPT.js"></script>

</body>
</html>
