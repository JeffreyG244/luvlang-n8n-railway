#!/usr/bin/env node
/**
 * BUILD-TIME ENVIRONMENT VARIABLE INJECTION
 *
 * This script runs during Vercel build to inject environment variables
 * directly into env-config.js. Values are JSON.stringify'd to handle
 * special characters safely.
 */

const fs = require('fs');
const path = require('path');

// Read environment variables (set in Vercel dashboard)
const config = {
    SUPABASE_URL: process.env.SUPABASE_URL || '',
    SUPABASE_ANON_KEY: process.env.SUPABASE_ANON_KEY || '',
    STRIPE_PUBLIC_KEY: process.env.STRIPE_PUBLIC_KEY || '',
    STRIPE_LINK_BASIC: process.env.STRIPE_LINK_BASIC || '',
    STRIPE_LINK_ADVANCED: process.env.STRIPE_LINK_ADVANCED || '',
    STRIPE_LINK_PREMIUM: process.env.STRIPE_LINK_PREMIUM || '',
    STRIPE_PRICE_INSTANT: process.env.STRIPE_PRICE_INSTANT || '',
    STRIPE_PRICE_PRECISION: process.env.STRIPE_PRICE_PRECISION || '',
    STRIPE_PRICE_LEGENDARY: process.env.STRIPE_PRICE_LEGENDARY || ''
};

console.log('üì¶ Building env-config.js...');
console.log('   SUPABASE_URL:', config.SUPABASE_URL ? '‚úì Set' : '‚úó Missing');
console.log('   SUPABASE_ANON_KEY:', config.SUPABASE_ANON_KEY ? '‚úì Set' : '‚úó Missing');
console.log('   STRIPE_PUBLIC_KEY:', config.STRIPE_PUBLIC_KEY ? '‚úì Set' : '‚úó Missing');

// Generate env-config.js with values injected at build time
// Using JSON.stringify ensures special characters are properly escaped
const configContent = `// Environment configuration for LuvLang Mastering
// AUTO-GENERATED by build-env.js at build time
// Build: ${new Date().toISOString()}
// DO NOT EDIT - changes will be overwritten on next deploy

console.log('üì¶ env-config.js loaded (build-time injected)');

window.__ENV__ = {
    SUPABASE_URL: ${JSON.stringify(config.SUPABASE_URL)},
    SUPABASE_ANON_KEY: ${JSON.stringify(config.SUPABASE_ANON_KEY)},
    STRIPE_PUBLIC_KEY: ${JSON.stringify(config.STRIPE_PUBLIC_KEY)},
    STRIPE_LINK_BASIC: ${JSON.stringify(config.STRIPE_LINK_BASIC)},
    STRIPE_LINK_ADVANCED: ${JSON.stringify(config.STRIPE_LINK_ADVANCED)},
    STRIPE_LINK_PREMIUM: ${JSON.stringify(config.STRIPE_LINK_PREMIUM)},
    STRIPE_PRICE_INSTANT: ${JSON.stringify(config.STRIPE_PRICE_INSTANT)},
    STRIPE_PRICE_PRECISION: ${JSON.stringify(config.STRIPE_PRICE_PRECISION)},
    STRIPE_PRICE_LEGENDARY: ${JSON.stringify(config.STRIPE_PRICE_LEGENDARY)},
    _loaded: true,
    _error: null
};

console.log('‚úÖ Environment config ready');
console.log('   SUPABASE_URL:', window.__ENV__.SUPABASE_URL ? '‚úì Set' : '‚úó Missing');
console.log('   SUPABASE_ANON_KEY:', window.__ENV__.SUPABASE_ANON_KEY ? '‚úì Set' : '‚úó Missing');

// Dispatch event so other scripts know config is ready
window.dispatchEvent(new CustomEvent('envConfigLoaded', { detail: window.__ENV__ }));
`;

// Write to env-config.js
const outputPath = path.join(__dirname, 'env-config.js');
fs.writeFileSync(outputPath, configContent);

console.log('‚úÖ env-config.js generated with build-time values');

// Validate
if (!config.SUPABASE_URL || !config.SUPABASE_ANON_KEY) {
    console.warn('‚ö†Ô∏è  Warning: Missing Supabase credentials');
    console.warn('   Set SUPABASE_URL and SUPABASE_ANON_KEY in Vercel Environment Variables');
}
