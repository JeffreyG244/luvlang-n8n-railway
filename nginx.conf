# Nginx Configuration for LuvLang Mastering Engine
# Add this to your nginx.conf or site-specific configuration

server {
    listen 80;
    server_name your-domain.com;

    # Root directory
    root /var/www/luvlang-mastering;
    index luvlang_LEGENDARY_COMPLETE.html;

    # ========================================================================
    # 1. MIME TYPES - Critical for WebAssembly
    # ========================================================================

    types {
        application/wasm                      wasm;
        application/javascript                js mjs;
        text/css                              css;
        text/html                             html htm;
        audio/wav                             wav;
        audio/mpeg                            mp3;
        audio/ogg                             ogg;
        font/woff2                            woff2;
        font/woff                             woff;
    }

    # ========================================================================
    # 2. CROSS-ORIGIN ISOLATION - Required for SharedArrayBuffer
    # ========================================================================

    # Apply to all responses
    add_header Cross-Origin-Opener-Policy "same-origin" always;
    add_header Cross-Origin-Embedder-Policy "require-corp" always;
    add_header Cross-Origin-Resource-Policy "cross-origin" always;

    # Security headers
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-XSS-Protection "1; mode=block" always;

    # ========================================================================
    # 3. CACHING - Optimize performance
    # ========================================================================

    # WebAssembly files - Cache forever
    location ~* \.wasm$ {
        add_header Content-Type "application/wasm";
        add_header Cache-Control "public, max-age=31536000, immutable";
        add_header Cross-Origin-Opener-Policy "same-origin" always;
        add_header Cross-Origin-Embedder-Policy "require-corp" always;

        # Try Brotli compressed version first
        gzip_static on;
        brotli_static on;
    }

    # JavaScript files - Cache forever
    location ~* \.js$ {
        add_header Content-Type "application/javascript; charset=utf-8";
        add_header Cache-Control "public, max-age=31536000, immutable";
        gzip_static on;
        brotli_static on;
    }

    # CSS files - Cache forever
    location ~* \.css$ {
        add_header Content-Type "text/css; charset=utf-8";
        add_header Cache-Control "public, max-age=31536000, immutable";
        gzip_static on;
        brotli_static on;
    }

    # HTML - No cache (always get latest)
    location ~* \.html$ {
        add_header Cache-Control "no-cache, no-store, must-revalidate";
        add_header Pragma "no-cache";
        add_header Expires "0";
    }

    # Audio files - No cache (streaming)
    location ~* \.(wav|mp3|ogg)$ {
        add_header Cache-Control "no-cache";
    }

    # Fonts - Cache forever
    location ~* \.(woff2|woff)$ {
        add_header Cache-Control "public, max-age=31536000, immutable";
    }

    # ========================================================================
    # 4. COMPRESSION - Gzip and Brotli
    # ========================================================================

    # Gzip compression
    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_types
        text/plain
        text/css
        text/xml
        text/javascript
        application/json
        application/javascript
        application/xml+rss
        application/atom+xml
        image/svg+xml
        application/wasm;

    # Brotli compression (if ngx_brotli module is installed)
    # brotli on;
    # brotli_comp_level 6;
    # brotli_types
    #     text/plain
    #     text/css
    #     text/xml
    #     text/javascript
    #     application/json
    #     application/javascript
    #     application/xml+rss
    #     application/atom+xml
    #     image/svg+xml
    #     application/wasm;

    # ========================================================================
    # 5. SERVING STATIC FILES
    # ========================================================================

    # Main location
    location / {
        try_files $uri $uri/ =404;
    }

    # Disable logging for static assets
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
        access_log off;
        log_not_found off;
    }

    # ========================================================================
    # 6. ERROR HANDLING
    # ========================================================================

    # Hide Nginx version
    server_tokens off;

    # Custom error pages (optional)
    # error_page 404 /404.html;
    # error_page 500 502 503 504 /50x.html;
}

# ============================================================================
# HTTPS Configuration (Recommended for production)
# ============================================================================

# Uncomment and configure for HTTPS
# server {
#     listen 443 ssl http2;
#     server_name your-domain.com;
#
#     ssl_certificate /path/to/ssl/cert.pem;
#     ssl_certificate_key /path/to/ssl/key.pem;
#
#     # Include all the configuration above
#     # ...
# }
#
# # Redirect HTTP to HTTPS
# server {
#     listen 80;
#     server_name your-domain.com;
#     return 301 https://$server_name$request_uri;
# }
